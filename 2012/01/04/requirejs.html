<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>.::PullRequest.org::. Organiser son code JavaScript avec RequireJS</title>
  <meta name="description" content="">
  <meta name="author" content="PullRequest team">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="/public/css/style.css">
  <link rel="stylesheet" href="/public/css/syntax.css">

  <script src="/public/js/libs/modernizr.custom.47336.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="/public/js/libs/jquery-1.6.2.min.js"><\/script>')</script>
</head>

<body>

  <div id="container">
    <header>
      <h1><a href="/" title="Page d'accueil"><img src="/public/img/pullrequest-logo.png" alt="PullRequest"/></a></h1>
      <a href="http://github.com/pullrequest"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 1;" src="https://a248.e.akamai.net/assets.github.com/img/abad93f42020b733148435e2cd92ce15c542d320/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub"></a>
    </header>

    <div id="main" role="main">
      <section id="content">
        
<article>
  <header>
    <h1><a href="/2012/01/04/requirejs.html">Organiser son code JavaScript avec RequireJS</a></h1>
    <p>
      <time datetime="2012-01-04" pubdate="pubdate">04 Jan 2012</time>
      <span class="author"><a href="/authors.html#filirom1">Romain Philibert</a></span>
      <span class="comments"><a href="#disqus_thread" title="Voir les commentaires">Commentaires</a></span>
    </p>
  </header>
  <p>Je suis certain que vous aussi, vous avez connu la frénésie jQuery. Le JavaScript prend de plus en plus de place au sein de l&#8217;application. On commence à avoir des difficultés à gérer l&#8217;ordre des balises scripts, le navigateur télécharge un nombre incroyable de fichiers js et le navigateur rame, on perd le compte du nombre de variables globales, on trouve du code javascript dans l&#8217;html et du html dans du javascript, le code dupliqué se multiplie et très vite, on ne sait plus qui fait quoi et rien n&#8217;est testé&#8230;</p>

<p>Alors comment s&#8217;en sortir ?</p>

<p>Il existe plusieurs méthodes qui couvrent un spectre plus ou moins large des problèmes exposés ci-dessus. Je vais commencer par vous les expliquer avant de vous présenter la solution que je préfère : <code>RequireJS</code>.</p>

<h2 id='module_pattern'>Module Pattern</h2>

<p><a href='http://www.adequatelygood.com/2010/3/JavaScript-Module-Pattern-In-Depth'>http://www.adequatelygood.com/2010/3/JavaScript-Module-Pattern-In-Depth</a></p>

<p>Il nous permet de ne pas pourrir notre scope global. En Javascript un scope est défini au niveau des fonctions. Pour éviter que nos variables arrivent dans le scope globale, il suffit de wrapper notre code autour d&#8217;une fonction et de l&#8217;exécuter tout de suite après.</p>
<div class='highlight'><pre><code class='javascript'><span class='p'>(</span><span class='kd'>function</span><span class='p'>(){</span>
  <span class='kd'>var</span> <span class='kr'>private</span> <span class='o'>=</span> <span class='s1'>&#39;I am private, the global scope is free of me !&#39;</span><span class='p'>;</span>

  <span class='kd'>function</span> <span class='nx'>iAmPrivateToo</span><span class='p'>(){</span>
    <span class='k'>return</span> <span class='s1'>&#39;This function is private and will not be available via the global scope !&#39;</span>
  <span class='p'>}</span>
<span class='p'>})()</span>
</code></pre>
</div>
<h2 id='object_litteral_pattern'>Object Litteral Pattern</h2>

<p><a href='http://stackoverflow.com/questions/1600130/javascript-advantages-of-object-literal'>http://stackoverflow.com/questions/1600130/javascript-advantages-of-object-literal</a></p>

<p>Maintenant que nous savons isolé notre code, nous devons le découper pour éviter de se retrouver avec un seul gros fichier.</p>

<p>A partir du moment où l&#8217;on découpe notre code, nous allons avoir besoin d&#8217;exporter des fonctions et des attributs publiquement dans une variable globale (ça va une seule, on ne crie pas au scandale tout de suite).</p>
<div class='highlight'><pre><code class='javascript'><span class='c1'>// script1.js</span>
<span class='p'>(</span><span class='kd'>function</span><span class='p'>(){</span>

  <span class='c1'>// if window.myApp does not exist, create it with an empty object</span>
  <span class='c1'>// multiple = are allowed in JS</span>
  <span class='c1'>// `var a = a || {};` is often used in JS, it means `var a or= {}`</span>
  <span class='kd'>var</span> <span class='nx'>myApp</span> <span class='o'>=</span> <span class='nb'>window</span><span class='p'>.</span><span class='nx'>myApp</span> <span class='o'>=</span> <span class='nb'>window</span><span class='p'>.</span><span class='nx'>myApp</span> <span class='o'>||</span> <span class='p'>{};</span>
  
  <span class='kd'>var</span> <span class='nx'>aPublicVariable</span> <span class='o'>=</span> <span class='s1'>&#39;I am public, yeahhh&#39;</span><span class='p'>;</span>
  
  <span class='kd'>function</span> <span class='nx'>aPublicFunction</span><span class='p'>(){</span>
    <span class='k'>return</span> <span class='s1'>&#39;This function will be public&#39;</span><span class='p'>;</span>
  <span class='p'>}</span>
  
  <span class='kd'>var</span> <span class='nx'>aPrivateVariable</span> <span class='o'>=</span> <span class='s1'>&#39;I am private, Yeahh !!!&#39;</span><span class='p'>;</span>
  
  <span class='kd'>function</span> <span class='nx'>aPrivateFunction</span><span class='p'>(){</span>
    <span class='k'>return</span> <span class='s1'>&#39;I will never export this function&#39;</span><span class='p'>;</span>
  <span class='p'>}</span>
  
  <span class='c1'>// exports public functions and variables</span>
  <span class='nx'>myApp</span><span class='p'>.</span><span class='nx'>aPublicVariable</span> <span class='o'>=</span> <span class='nx'>aPublicVariable</span><span class='p'>;</span>
  <span class='nx'>myApp</span><span class='p'>.</span><span class='nx'>aPublicFunction</span> <span class='o'>=</span> <span class='nx'>aPublicFunction</span><span class='p'>;</span>
<span class='p'>})();</span>

<span class='c1'>// script2.js use script1 functions</span>
<span class='p'>(</span><span class='kd'>function</span><span class='p'>(){</span>
  <span class='kd'>var</span> <span class='nx'>myApp</span> <span class='o'>=</span> <span class='nb'>window</span><span class='p'>.</span><span class='nx'>myApp</span> <span class='o'>=</span> <span class='nb'>window</span><span class='p'>.</span><span class='nx'>myApp</span> <span class='o'>||</span> <span class='p'>{};</span>
  
  <span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='nx'>myApp</span><span class='p'>.</span><span class='nx'>aPublicFunction</span><span class='p'>());</span>
<span class='p'>})();</span>
</code></pre>
</div>
<p>Attention script2 dépend de script1. Il y a un ordre à respecter au niveau de la déclaration des dépendances.</p>
<div class='highlight'><pre><code class='html'><span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;script1.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
<span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;script2.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
</code></pre>
</div>
<h2 id='grouper_les_fichiers_js_pour_la_prod'>Grouper les fichiers JS pour la prod</h2>

<p>On se retrouve avec deux fichiers JavaScripts, pour le développement c&#8217;est mieux, mais pour la prod c&#8217;est moins bien ! On a augmenté le nombre de ressources à faire télécharger par le navigateur. Maintenant, il faut grouper et minifier les ressources JS avant de les servir en prod. Pour faire ça, nous pouvons utiliser un simple script shell:</p>

<pre><code>cat js/src/* &gt;&gt; js/build/app.js</code></pre>

<p>Mais attention, les dépendances risquent d&#8217;être cassées. Nous pouvons également utiliser des outils plus évolués :</p>

<ul>
<li><a href='http://code.google.com/p/wro4j/'>Wro4J</a> qui possède même un plugin Tapestry <a href='https://github.com/lltyk/tapestry-wro4j'>https://github.com/lltyk/tapestry-wro4j</a> ;)</li>

<li>le script de build de <a href='https://github.com/h5bp/html5-boilerplate/wiki/Build-script'>html5 boilerplate</a> * &#8230;</li>
</ul>

<p>Si vous avez d&#8217;autres outils, laissez un commentaire à cet article.</p>

<h2 id='gestion_des_dpendances_avec_requirejs'>Gestion des dépendances avec RequireJS</h2>

<p>C&#8217;est à ce moment que je commence à vous parler de RequireJS.</p>

<p>RequireJS a été créé par <a href='https://github.com/jrburke'>James Burke</a>, pour DOJO. Mais finalement, cette librairie a été séparé du projet initial pour devenir framework agnostique. Merci James ;)</p>

<p>RequireJs va vous permettre de faire :</p>

<ul>
<li>de l&#8217;encapsulation (visibilité public / privée )</li>

<li>de la modularité</li>

<li>de la gestion de dépendances</li>

<li>de ne plus écrire d&#8217;HTML dans des fichiers JS</li>

<li>de l&#8217;optimisation d&#8217;assets (grouper et minifier les JS et les CSS)</li>
</ul>

<p>RequireJS est actuellement la solution mise en avant par :</p>

<ul>
<li><a href='http://jqfundamentals.com/'>Rebecca Murphey pour utiliser RequireJS avec jQuery</a></li>

<li><a href='https://github.com/addyosmani/backbone-fundamentals'>Addy Osmani pour utiliser RequireJS avec Backbone</a></li>

<li><a href='http://www.quora.com/What-are-the-use-cases-for-RequireJS-vs-Yepnope-vs-LABjs'>Alex Sexton le père de YepNope, qui explique pourquoi il préfère RequireJS</a></li>

<li><a href='http://resthub.org/javascript/'>Resthub-JS dans sa solution pour construire des Single Page Web Apps</a></li>
</ul>

<p>Voici un exemple de code de RequireJS, suivez les commentaires pour les explications.</p>
<div class='highlight'><pre><code class='javascript'><span class='cm'>/* js/script1.js */</span>
<span class='nx'>define</span><span class='p'>(</span>
  <span class='nx'>id</span><span class='p'>,</span> <span class='cm'>/* (optionnel) */</span>
  <span class='p'>[</span> <span class='s1'>&#39;jquery&#39;</span><span class='p'>,</span> <span class='s1'>&#39;underscore&#39;</span> <span class='p'>],</span> <span class='cm'>/* La liste des dépendances */</span>
  <span class='kd'>function</span><span class='p'>(</span><span class='nx'>$</span><span class='p'>,</span> <span class='nx'>_</span><span class='p'>)</span> <span class='p'>{</span> 
    <span class='cm'>/* on retrouve le module pattern ici */</span>
    <span class='kd'>var</span> <span class='nx'>privateVariable</span> <span class='o'>=</span> <span class='s1'>&#39;I am private&#39;</span><span class='p'>;</span>
    <span class='kd'>function</span> <span class='nx'>privateFunction</span><span class='p'>(){</span> <span class='p'>...</span> <span class='p'>}</span>
    
    <span class='kd'>var</span> <span class='nx'>publicVariable</span> <span class='o'>=</span> <span class='s1'>&#39;I am public&#39;</span><span class='p'>;</span>
    <span class='kd'>function</span> <span class='nx'>publicFunction</span><span class='p'>(){</span> <span class='p'>...</span> <span class='p'>}</span>
  
    <span class='cm'>/* Variables et functions à exporter */</span>
    <span class='k'>return</span> <span class='p'>{</span>
        <span class='nx'>publicVariable</span><span class='o'>:</span> <span class='nx'>publicVariable</span><span class='p'>,</span>
        <span class='nx'>publicFunction</span><span class='o'>:</span> <span class='nx'>publicFunction</span>
    <span class='p'>}</span>
  <span class='p'>}</span>
<span class='p'>)</span>

<span class='cm'>/* bootstrap.js qui utilise la dépendance définie ci dessus. */</span>
<span class='nx'>require</span><span class='p'>({</span>
  <span class='nx'>paths</span><span class='o'>:</span> <span class='p'>{</span>
    <span class='nx'>jquery</span><span class='o'>:</span> <span class='s1'>&#39;js/libs/jquery-1.7.1.min&#39;</span><span class='p'>,</span>
    <span class='nx'>underscore</span><span class='o'>:</span> <span class='s1'>&#39;js/libs/underscore-min&#39;</span>
  <span class='p'>}</span>
<span class='p'>},[</span><span class='s1'>&#39;js/script1&#39;</span><span class='p'>],</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>script1</span><span class='p'>){</span>
    <span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='nx'>script</span><span class='p'>.</span><span class='nx'>publicFunction</span><span class='p'>());</span>
<span class='p'>})</span>
</code></pre>
</div>
<p>Reprenons l&#8217;exemple précédent tout doucement.</p>

<p>RequireJS définit deux notions : <code>define</code> et <code>require</code>. Simple non :D</p>

<ul>
<li><code>define</code> permet de définir un module avec des dépendances et des choses (fonction ou variable) à exporter.</li>

<li><code>require</code> permet de charger dynamiquement des modules.</li>
</ul>

<h3 id='dfinir_un_module_avec_'>Définir un module avec <code>define</code></h3>

<p>Si nous prenons l&#8217;exemple d&#8217;un module simple.</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>define</span><span class='p'>([</span>
    <span class='s1'>&#39;jquery&#39;</span><span class='p'>,</span>
    <span class='s1'>&#39;underscore&#39;</span><span class='p'>,</span>
    <span class='s1'>&#39;js/myScript&#39;</span><span class='p'>,</span>
    <span class='p'>...</span>
<span class='p'>],</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>$</span><span class='p'>,</span> <span class='nx'>_</span><span class='p'>,</span> <span class='nx'>myScript</span><span class='p'>,</span> <span class='p'>...){</span>
  
  <span class='cm'>/* your private methods and variable here */</span>
  
  <span class='k'>return</span> <span class='p'>{</span> <span class='cm'>/* your public variables and functions here */</span> <span class='p'>}</span>
<span class='p'>});</span>
</code></pre>
</div>
<p>Je n&#8217;ai pas spécifié l&#8217;ID, RequireJs va s&#8217;en occuper pour moi et je vous conseil de faire de même. Votre code sera réutilisable plus facilement.</p>

<p>Dans mon module, j&#8217;ai spécifié une liste de dépendances.</p>
<div class='highlight'><pre><code class='javascript'><span class='p'>[</span>
  <span class='s1'>&#39;jquery&#39;</span><span class='p'>,</span>
  <span class='s1'>&#39;underscore&#39;</span><span class='p'>,</span>
  <span class='s1'>&#39;js/myScript&#39;</span><span class='p'>,</span>
  <span class='p'>...</span>
<span class='p'>]</span>
</code></pre>
</div>
<p>Nous remarquons que pour myScript, le nom de la dépendance correspond à son chemin sans l&#8217;extension. Nous verrons par la suite comment configurer RequireJS afin de donner des chemins raccourcis (comme pour jQuery et underscore).</p>

<p>RequireJs m&#8217;assure que les dépendances seront chargées et accessibles à l&#8217;intérieur de la fonction : <code>function($, _, myScript, ...){ ... }</code></p>

<p>Mon module peut exporter des choses (fonction ou variable) à l&#8217;aide du return: <code>return { publicFunction: publicFunction, .... }</code> Tout ce qui n&#8217;est pas exporté est privé. Simple n&#8217;est-ce pas ;)</p>

<p>Et comme vous l&#8217;aurez supposé, tout ce qui est exporté par un module est disponible par les autres modules via les arguments de la fonction : <code>$, _, myScript, ...</code></p>

<p>RequireJs va s&#8217;occuper de charger les dépendances des dépendances, &#8230; et au final je n&#8217;aurai plus qu&#8217;à définir qu&#8217;un seul module : myApplication et de ne charger que ce module pour que toutes les dépendances de mon application soient chargées automatiquement (ce n&#8217;est plus à nous de gérer l&#8217;ordre c&#8217;est cool ;) ).</p>

<h3 id='charger_des_modules_avec_'>Charger des modules avec <code>require</code></h3>

<p>Maintenant c&#8217;est sympa nous avons défini des modules, mais il nous manque un point d&#8217;entrée à notre application. C&#8217;est le rôle de <code>require</code> de faire ça. L&#8217;appel à <code>require</code> va charger dynamiquement un module, puis ses dépendances, puis appeler la fonction passée en dernier paramètre.</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>require</span><span class='p'>({</span>
  <span class='nx'>paths</span><span class='o'>:</span> <span class='p'>{</span>
    <span class='nx'>jquery</span><span class='o'>:</span> <span class='s1'>&#39;js/libs/jquery-1.7.1.min&#39;</span><span class='p'>,</span>
    <span class='nx'>underscore</span><span class='o'>:</span> <span class='s1'>&#39;js/libs/underscore-min&#39;</span>
  <span class='p'>}</span>
<span class='p'>},[</span><span class='s1'>&#39;jquery&#39;</span><span class='p'>,</span> <span class='s1'>&#39;js/script1&#39;</span><span class='p'>],</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>$</span><span class='p'>,</span> <span class='nx'>script1</span><span class='p'>){</span>
  <span class='nx'>$</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(){</span>
    <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#myID&#39;</span><span class='p'>).</span><span class='nx'>text</span><span class='p'>(</span><span class='s1'>&#39;Loaded &#39;</span> <span class='o'>+</span> <span class='nx'>script1</span><span class='p'>.</span><span class='nx'>publicFunction</span><span class='p'>());</span>
  <span class='p'>});</span>
<span class='p'>})</span>
</code></pre>
</div>
<h3 id='configurer_requirejs'>Configurer RequireJS</h3>

<p>Comme vous l&#8217;avez remarqué, le premier paramètre de RequireJS est un objet de configuration :</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>paths</span><span class='o'>:</span> <span class='p'>{</span>
  <span class='nx'>jquery</span><span class='o'>:</span> <span class='s1'>&#39;js/libs/jquery-1.7.1.min&#39;</span><span class='p'>,</span>
  <span class='nx'>underscore</span><span class='o'>:</span> <span class='s1'>&#39;js/libs/underscore-min&#39;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>Le paramètre <code>paths</code> nous permet de définir l&#8217;emplacement des librairies utilisées</p>

<p>Tout à l&#8217;heure je vous ai dit, n&#8217;utilisez pas d&#8217;ID dans vos modules et vous allez maintenant comprendre pourquoi.</p>

<p>jQuery définie dans son <a href='https://github.com/jquery/jquery/blob/cae1b6174917df3b4db661f20ef4745dd6e7f305/src/core.js#L949'>code</a> un <code>define(&#39;jquery&#39;, function(){ return jQuery });</code> Le premier paramètre <code>jquery</code> est l&#8217;ID et nous oblige à utiliser le terme <code>jquery</code> pour l&#8217;ajouter en tant que dépendance. Vous avez compris, c&#8217;est relou, alors ne le faîtes pas :)</p>

<p>Normalement nous aurions pu faire appel à jquery via son chemin complet : <code>define([&#39;js/libs/jquery-1.7.1.min&#39;], function($){ ... })</code>, mais à cause de l&#8217;ID nous devons faire réference à jquery par son id :<code>define([&#39;jquery&#39;], function($){ ... })</code></p>

<p>C&#8217;est le rôle de la configuration <code>paths: { jquery: &#39;js/libs/jquery-1.7.1.min&#39;, }</code>. RequireJS va remplacer chaque dépendance <code>jquery</code> par son chemin réel afin de trouver la librairie.</p>

<h4 id='requirejs_et_jquery'>RequireJS et jQuery</h4>

<p>Depuis jQuery 1.7, le support de AMD (RequireJS est un implémentation de AMD) à été ajouté.</p>

<p>Pour les versions précédentes il existe une version de RequireJS qui intègre jQuery : <a href='https://github.com/jrburke/require-jquery'>https://github.com/jrburke/require-jquery</a></p>

<h4 id='requirejs_et_backbone'>RequireJS et Backbone</h4>

<p>Si vous voulez utiliser RequireJS avec Backbone, James Burke le créateur de RequireJS a créé un repo avec une version de Backbone compatible AMD : <a href='https://github.com/jrburke/backbone/blob/optamd3/backbone.js'>https://github.com/jrburke/backbone/blob/optamd3/backbone.js</a></p>

<p>Une <a href='https://github.com/documentcloud/backbone/pull/710'>issue</a> est en cours sur Github pour que ce fork soir mergé avec Backbone.</p>

<h3 id='intgrer_requirejs_dans_notre_html'>Intégrer RequireJS dans notre HTML</h3>

<p>Il faut rajouter dans le HTML les balises <code>script</code> pour RequireJS et notre bootstrap.js (celui faisant appel à toute nos dépendances) afin que le navigateur charge notre application.</p>
<div class='highlight'><pre><code class='html'><span class='nt'>&lt;html&gt;</span>
    <span class='nt'>&lt;head&gt;</span>...<span class='nt'>&lt;/head&gt;</span>
    <span class='nt'>&lt;body&gt;</span>
      <span class='c'>&lt;!-- Ajoutons requireJS et notre script à la fin du body --&gt;</span>
      <span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;require.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
      <span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;bootstrap.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
    <span class='nt'>&lt;/body&gt;</span>
<span class='nt'>&lt;/html&gt;</span>
</code></pre>
</div>
<p>RequireJS rajoutera les dépendances chargées via des balises script dans le head et le navigateur les chargera automatiquement. Si la dépendance est nécessaire plusieurs fois, RequireJs a l&#8217;intelligence de ne la récupérer qu&#8217;une seule fois.</p>

<p>Maintenant lorsque nous naviguons sur notre site, le navigateur télécharge RequireJS, le bootstrap, et toutes les dépendances.</p>

<h3 id='optimiser_les_ressources'>Optimiser les ressources</h3>

<p>Avec RequireJS nous avons découpé notre application en plusieurs fichiers, malheureusement tous les fichiers sont téléchargés un par un par le navigateur.</p>

<p>Nous aurions besoin de grouper et minifier l&#8217;ensemble de ces fichiers avant de les servir en production.</p>

<p>RequireJS arrive avec un <a href='https://github.com/jrburke/r.js/'>script de build</a> qui a exactement ce rôle là.</p>

<p>Si on appelle r.js avec le paramètre -o et en lui spécifiant un fichier de configuration : <code>r.js -o build.js</code>. r.js va parcourir l&#8217;ensemble des scripts et les minifier, puis va parcourir nos dépendances afin de les grouper. Les fichiers résultant seront placés dans un nouveau répertoire afin de ne pas écraser les sources.</p>
<div class='highlight'><pre><code class='javascript'><span class='p'>({</span>
    <span class='nx'>appDir</span><span class='o'>:</span> <span class='s1'>&#39;./src&#39;</span><span class='p'>,</span>    <span class='cm'>/* Repertoire des sources */</span>
    <span class='nx'>baseUrl</span><span class='o'>:</span> <span class='s2'>&quot;.&quot;</span><span class='p'>,</span>       <span class='cm'>/* Le repertoire racine */</span>
    <span class='nx'>dir</span><span class='o'>:</span> <span class='s2'>&quot;./build&quot;</span><span class='p'>,</span>     <span class='cm'>/* Repertoire de destination */</span>
    <span class='nx'>modules</span><span class='o'>:</span> <span class='p'>[</span> <span class='p'>{</span>
      <span class='nx'>name</span><span class='o'>:</span> <span class='s1'>&#39;bootstrap&#39;</span> <span class='cm'>/* Une dependance vers un module */</span>
    <span class='p'>}</span> <span class='p'>],</span>
    <span class='nx'>optimizeCss</span><span class='o'>:</span> <span class='s2'>&quot;standard.keepLines&quot;</span><span class='p'>,</span> <span class='cm'>/* On va même optimiser les CSS */</span>
    <span class='nx'>dirExclusionRegExp</span><span class='o'>:</span> <span class='sr'>/node_modules|test|build/</span> <span class='cm'>/* on va exclure du processus de build certain repertoires. */</span>
<span class='p'>})</span>
</code></pre>
</div>
<p>Le fichier bootstrap.js du répertoire build contiendra l&#8217;ensemble de notre code js minifié.</p>

<p>PS : r.js nécessite node ou Rhino pour fonctionner.</p>

<h3 id='chargement_dynamique_de_code'>Chargement dynamique de code</h3>

<p>Il se peut que lors de la construction d&#8217;une Single Page Web App vous ayez besoin de définir des ensembles de modules. Par exemple un module qui contient l&#8217;ensemble du code JS pour le frontend de votre appli et un autre module qui va contenir le code JS supplémentaire nécessaire pour charger le backend.</p>

<p>Vous ne souhaitez pas que les internautes qui accèdent à votre frontend soit ralenti par le téléchargement des ressources du backend.</p>

<p>C&#8217;est pour répondre à cette problématique que le script de build r.js peut être configuré avec plusieurs modules ayant des options d&#8217;include et d&#8217;exclude.</p>

<h3 id='requirejs_sur_mobile'>RequireJS sur mobile</h3>

<p>Sur mobile on a toujours des contraintes des taille. Nous ne voulons surtout pas charger de librairies inutilement. Du fait que nous avons utilisé la structuration AMD (Asynchrnous Module Definition) dans notre code, nous sommes obligé d&#8217;utiliser une implementation AMD pour lancer notre application et RequireJs n&#8217;est pas la seule implémentation existante.</p>

<p>Actuellement il en existe plusieurs dont 3 que j&#8217;ai testé personnellement.</p>

<ul>
<li>Almond la plus petite (moins de 1Ko gzippé) ne fait pas de chargement dynamique; tous les modules doivent être contenus dans un seul fichier. Elle fonctionne très bien en complément du script builder r.js. Comme tout le code est groupé en un seul fichier, Almond peut faire son travail. Almond est la solution privilégiée sur mobile.</li>

<li>Curl.js qui est deux fois moins gros que RequireJs et peut être une bonne alternative si vous avez besoin de chargement dynamique de code.</li>
</ul>

<p>Par contre, sur des projets un peu gros, souvent RequireJS est le seul à s&#8217;en sortir.</p>

<p>Et voici une comparaison des implémentations en terme de taille</p>

<pre><code>$ ls -l
-rw-r--r-- 1 romain users  925 29 nov.  15:41 almond.min.js.gz
-rw-r--r-- 1 romain users 2,6K 29 nov.  15:41 curl.js.gz
-rw-r--r-- 1 romain users 5,5K 29 nov.  15:41 require.js.gz</code></pre>

<p>Si vous utilisez Almond qui ne fait pas de chargement dynamique, vous aurez besoin en prod de remplacer &#8216;RequireJS + votre code&#8217; par un seul fichier minifié contenant tout.</p>
<div class='highlight'><pre><code class='html'>- <span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;require.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
- <span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;boostrap.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
+ <span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;almond-and-bootstrap.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
</code></pre>
</div>
<p>Pour cela vous pouvez :</p>

<ul>
<li>soit utiliser <a href='https://github.com/jrburke/r.js/blob/master/build/tests/http/httpBuild.js'>httpBuild</a> afin de toujours compiler en dev vos assets RequireJS côté serveur (utilise nodejs)</li>

<li>soit utiliser les fonctionnalités de <a href='http://requirejs.org/docs/optimization.html#hasjs'>has avec RequireJS</a> : <a href='https://github.com/alankligman/gladius/blob/develop/src/gladius.js'>exemple</a></li>
</ul>

<h3 id='stop_au_js_dans_les_html_et__lhtml_dans_les_js'>Stop au JS dans les HTML et à l&#8217;HTML dans les JS</h3>

<p>Avec RequireJS et son plugin text vous avez la chance, de ne plus jamais écrire de JavaScript dans des fichiers HTML, ni d&#8217;écrire du HTML dans les fichiers JavaScript.</p>

<p>Voici un exemple de module RequireJS avec une dépendance texte (regardez le préfixe text!) :</p>
<div class='highlight'><pre><code class='javascript'><span class='cm'>/* bootstrap.js */</span>
<span class='nx'>require</span><span class='p'>([</span>
  <span class='s1'>&#39;jquery&#39;</span><span class='p'>,</span>
  <span class='s1'>&#39;underscore&#39;</span><span class='p'>,</span>
  <span class='s1'>&#39;text!views/template.html&#39;</span>
<span class='p'>],</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>$</span><span class='p'>,</span> <span class='nx'>_</span><span class='p'>,</span> <span class='nx'>tmpl</span><span class='p'>){</span>
  <span class='kd'>var</span> <span class='nx'>compiledTemplate</span> <span class='o'>=</span> <span class='nx'>_</span><span class='p'>.</span><span class='nx'>template</span><span class='p'>(</span><span class='nx'>tmpl</span><span class='p'>);</span>

  <span class='nx'>$</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(){</span>
    <span class='kd'>var</span> <span class='nx'>$el</span> <span class='o'>=</span> <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;.injectHere&#39;</span><span class='p'>);</span>
    <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;.btn&#39;</span><span class='p'>).</span><span class='nx'>click</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(){</span>
        <span class='nx'>$el</span><span class='p'>.</span><span class='nx'>html</span><span class='p'>(</span><span class='nx'>compiledtemplat</span><span class='p'>({</span>
            <span class='nx'>firstName</span><span class='o'>:</span> <span class='nx'>firstName</span><span class='p'>,</span>
            <span class='nx'>lastName</span><span class='o'>:</span> <span class='nx'>lastName</span>
        <span class='p'>})));</span>
    <span class='p'>});</span>
  <span class='p'>});</span>
<span class='p'>})</span>
</code></pre>
</div>
<p>Et voici le template en HTML utilisant le <a href='http://documentcloud.github.com/underscore/#template'>micro templating underscore</a></p>
<div class='highlight'><pre><code class='javascript'><span class='c'>&lt;!--</span> <span class='nx'>views</span><span class='o'>/</span><span class='nx'>template</span><span class='p'>.</span><span class='nx'>html</span> <span class='o'>--&gt;</span>
<span class='o'>&lt;</span><span class='nx'>div</span> <span class='kr'>class</span><span class='o'>=</span><span class='s2'>&quot;personn&quot;</span><span class='o'>&gt;</span>
    <span class='o'>&lt;</span><span class='nx'>p</span><span class='o'>&gt;</span><span class='nx'>My</span> <span class='nx'>name</span> <span class='nx'>is</span> <span class='o'>&lt;%=</span> <span class='nx'>firstName</span> <span class='o'>%&gt;</span> <span class='o'>&lt;%=</span> <span class='nx'>lastName</span> <span class='o'>%&gt;&lt;</span><span class='err'>/p&gt;</span>
<span class='o'>&lt;</span><span class='err'>/div&gt;</span>
</code></pre>
</div>
<p>Si on faisait tourner le script de build r.js on obtiendrait dans le même fichier :</p>

<ul>
<li>jQuery</li>

<li>undercore</li>

<li>le template inliné. Il ressemblerait à ça : define(&#8216;text!views/template.html&#8217;, function(){ return &#8216;&lt; div class= &#8230;.&#8217; });</li>

<li>et notre bootstrap.js</li>
</ul>

<p>RequireJS possède même des plugins afin de compiler les templates par le script de build r.js : <a href='https://github.com/ZeeAgency/requirejs-tpl'>underscore template</a>, <a href='https://github.com/SlexAxton/require-handlebars-plugin'>handlebars</a> . Encore une chose de moins à faire côté client :).</p>

<h2 id='conclusion'>Conclusion</h2>

<p>Bien RequireJS puisse paraitre un poil complexe à configurer, RequireJs permet de répondre à pas mal de problématiques et pour l&#8217;instant je n&#8217;ai rien trouvé de mieux pour faire des Single Page Web Apps (SPA).</p>

<p>D&#8217;ailleurs, pour de la SPA : RequireJS + Backbone c&#8217;est un must have. Je l&#8217;ai déjà cité, mais regardez le livre de Addy Osmani : <a href='https://github.com/addyosmani/backbone-fundamentals'>Backbone Fondamentals</a> il vaut vraiment le coup.</p>

<p>Si vous voulez voir des exemples de code utilisant RequireJS, j&#8217;ai créé un repo pour ça : <a href='https://github.com/Filirom1/requirejs-examples'>https://github.com/Filirom1/requirejs-examples</a> à l&#8217;occasion d&#8217;un talk à <a href='http://lyonjs.org'>LyonJS</a>.</p>

<p>Et concernant les tests, jetez un oeil à <a href='https://github.com/tkellen/js-library-skeleton'>js-library-skeleton</a> qui est un exemple d&#8217;integration de RequireJs, r.js, Almond et le framework de test Jasmine.</p>

<p>Si vous souhaitez plus de ressources sur RequireJS :</p>

<ul>
<li><a href='http://requirejs.org/'>Lisez le site officiel de RequireJS</a></li>

<li><a href='http://addyosmani.com/writing-modular-js/'>Plongez vous dans la présentation de AMD, CommonJS et des ES imports/exports par Addy Osmani</a></li>

<li><a href='http://blog.mklog.fr/article/require-js'>Lisez l&#8217;article de mklabs</a></li>

<li><a href='https://github.com/millermedeiros/requirejs-plugins'>Si vous souhaitez des plugins supplémentaire pour RequireJS</a></li>

<li><a href='https://github.com/jrburke/almond'>Sur mobile essayez Almond</a></li>

<li><a href='https://github.com/unscriptable/curl'>sinon curl</a></li>
</ul>

<p>Merci d&#8217;avoir lu cet article jusqu&#8217;au bout ;)</p>
  <footer>
    <section class="tags">
      <span>Tags :</span>
<ul>
  
    <li>
        <a href="tags.html#requirejs" title="Voir les posts ayant le tag requirejs">requirejs</a>
    </li>
  
    <li>
        <a href="tags.html#javascript" title="Voir les posts ayant le tag javascript">javascript</a>
    </li>
  
    <li>
        <a href="tags.html#webapp" title="Voir les posts ayant le tag webapp">webapp</a>
    </li>
  
</ul>

    </section>
    <section id="disqus_thread" class="comments">
      <script type="text/javascript">
  var disqus_shortname = 'pullrequest';
  var disqus_identifier = '/2012/01/04/requirejs';
  $.getScript("http://pullrequest.disqus.com/embed.js");
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus</a>.</noscript>

    </section>
  </footer>
</article>

      </section><!--

   --><aside>
        <section id="about">
          <h1>A propos</h1>
          <p>PullRequest est un blog de développeurs ouvert à toute contribution appropriée.</p>
        </section>
        <section id="follow">
          <h1>Suivez nous!</h1>
          <ul>
            <li>
              <a href="http://twitter.com/pullrequest" class="twitter-follow-button" data-show-count="false" data-lang="fr">Follow @pullrequest</a>
              <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
            </li>
            <li class="feed">
              <a rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/pullrequest/blog-posts">abonnement RSS</a>
            </li>
          </ul>
        </section>
        <section id="contribute">
          <h1>Participer</h1>
          <p>
            Les articles sont écrits en <a href="http://daringfireball.net/projects/markdown/syntax">MarkDown</a> et stockés dans un repository Git sur <a href="http://github.com/pullrequest/pullrequest.github.com">Github</a>.
            N'hésitez pas à <strong>forker</strong> puis à faire une <strong><a href="https://github.com/pullrequest/pullrequest.github.com/pull/new/master">Pull Request</a></strong> ;)
          </p>
        </section>
        <section id="licensing">
          <h1>Licence</h1>
          <p>
            Les articles sont mis à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by/2.0/fr/">Licence Creative Commons Paternité 2.0 France</a>.
            <a rel="license" href="http://creativecommons.org/licenses/by/2.0/fr/">
              <br><img alt="Contrat Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by/2.0/fr/88x31.png" />
            </a>
          </p>
        </section>
        <section id="opensource">
          <h1>OpenSource</h1>
          <p>Les auteurs de PullRequest sont à l'origine, ou contributeurs, entre autres, de ces projets:</p>
          <ul>
            <li><a href="http://openscales.org">OpenScales</a></li>
            <li><a href="http://resthub.org">RestHub</a></li>
            <li><a href="https://github.com/loicfrering/LosoBundle">LosoBundle</a></li>
            <li><a href="https://github.com/loicfrering/losolib">LoSoLib</a></li>
            <li><a href="https://bitbucket.org/feugy/myth">Myth</a></li>
          </ul>
        </section>
      </aside>

    </div>

    <footer>
      <small id="legal">© 2011 pullrequest.org</small>
      <small id="poweredby">Propulsé par <a href="http://jekyllrb.com">Jekyll</a></small>
    </footer>
  </div>

  <script defer src="/public/js/tags.js"></script>
  <script defer src="/public/js/authors.js"></script>

  <script>
    var _gaq=[["_setAccount","UA-22833612-1"],["_trackPageview"]];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
    g.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js";
    s.parentNode.insertBefore(g,s)}(document,"script"));
  </script>

  <!--[if lt IE 7 ]>
  <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
  <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

</body>
</html>
