<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>.::PullRequest.org::. Des astuces pour structurer un projet BackboneJS</title>
  <meta name="description" content="">
  <meta name="author" content="PullRequest team">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="/public/css/style.css">
  <link rel="stylesheet" href="/public/css/syntax.css">

  <script src="/public/js/libs/modernizr.custom.47336.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="/public/js/libs/jquery-1.6.2.min.js"><\/script>')</script>
</head>

<body>

  <div id="container">
    <header>
      <h1><a href="/" title="Page d'accueil"><img src="/public/img/pullrequest-logo.png" alt="PullRequest"/></a></h1>
      <a href="http://github.com/pullrequest"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 1;" src="https://a248.e.akamai.net/assets.github.com/img/abad93f42020b733148435e2cd92ce15c542d320/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub"></a>
    </header>

    <div id="main" role="main">
      <section id="content">
        
<article>
  <header>
    <h1><a href="/2012/02/25/backbone-tips-from-document-cloud.html">Des astuces pour structurer un projet BackboneJS</a></h1>
    <p>
      <time datetime="2012-02-25" pubdate="pubdate">25 Feb 2012</time>
      <span class="author"><a href="/authors.html#filirom1">Romain Philibert</a></span>
      <span class="comments"><a href="#disqus_thread" title="Voir les commentaires">Commentaires</a></span>
    </p>
  </header>
  <style>
.code {
  font-size: 90%;
}
</style>
<p><a href='http://documentcloud.github.com/backbone/'>Bakbone</a> est un projet que j&#8217;aime beaucoup car il embarque en très peu de lignes, un ensemble de bonnes pratiques qui rendra votre code bien plus lisible et compréhensible par les autres développeurs.</p>
<p class='center'>
  <img border='0' src='/public/img/2012-02-25-backbone-tips-from-document-cloud/backbone.png' />
</p>
<p>Mais Backbone comme jQuery, vous laisse relativement libre pour structurer votre application. Ce qui est très bien, mais qui pourrait vous laisser un peu démuni pendant la phase d&#8217;apprentissage.</p>

<p>Cet article fait suite à <a href='http://filirom1.github.com/lyonjs-DocumentCloud-slides/'>une session LyonJS</a>, pendant laquelle je commentais les sources de DocumentCloud afin d&#8217;en sortir les bonnes pratiques.</p>

<p>Maintenant, je vais beaucoup vous parler de la structuration d&#8217;un projet Backbone, mais finalement très peu du framework en tant que tel. Je vous laisse le soin de lire la <a href='http://documentcloud.github.com/backbone/'>doc officiel</a>, ou même le <a href='http://documentcloud.github.com/backbone/docs/backbone.html'>code commenté</a> car celui ci est très claire. Pour ceux qui ne le connaissent pas encore, Backbone possède un Routeur pour gérer des URLs, des modèles et des collections qui ne partagent pas le même cycle de vie que les vues, des vues qui sont misent à jours automatiquement dès que le modèle change, un système d&#8217;événements simple mais efficace, un modèle objet très pratique, &#8230; et tout ça dans 5Ko :)</p>

<p>Ce qui m&#8217;a plu dans l&#8217;utilisation faite de Backbone chez DocumentCloud, c&#8217;est la simplicité et la facilité de compréhension du code. Je vais donc vous présenter une approche pragmatique et minimaliste qui vous permettra de mettre en place des projets fronts conséquent (comme celui de <a href='http://www.documentcloud.org/public/search/'>DocumentCloud</a>).</p>

<p>Cet article se détache des présentations du type <a href='http://addyosmani.com/blog/large-scale-jquery/'>How to build large scale jQuery applications</a> qui je trouve bien pensé mais plus complexe à appliquer. Je trouve l&#8217;idée d&#8217;utiliser RequireJs et un PubSub intéressante, mais au final cela entraine une surcouche de complexité qui n&#8217;est pas nécessaire pour toute les applications.</p>

<h3 id='structuration_des_fichiers'> Structuration des fichiers</h3>

<pre><code>.
├── index.html                       // l&#39;unique fichier HTML (nous sommes sur une SPA)
├── css
│   └── ...                          // les feuilles de styles
├── js
│   ├── application.js               // défini le namespace + le routeur
│   ├── model
│   │   └── ...                      // ensemble des modèles et collections
│   ├── ui
│   │   └── ...                      // ensemble des vues backbones
│   ├── lib
│   │   ├── backbone.extension.js    // plugins Backbone fait maison
│   │   └── jquery.extension.js      // plugins jQuery fait maison
│   └── vendor                       // librairies externes
│       ├── backbone.js
│       ├── jquery.js
│       └── underscore.js
└── template
    └── ...                          // Nos templates au format JST</code></pre>

<h3 id='indexhtml'>Index.html</h3>

<p>Backbone, grâce à son Routeur, nous permet de construire des Single Page Web Applications (SPA) très simplement.</p>

<p>Une SPA signifie qu&#8217;il n&#8217;y a qu&#8217;un seul fichier HTML à charger pour gérer l&#8217;ensemble de l&#8217;application.</p>

<p>Ce fichier est en général très simple puisque les templates seront injectées dans le DOM en fonction de l&#8217;URL de la page.</p>

<p>Si vous voulez un exemple d&#8217;index.html prenez celui de HTML5Boilerplate dont voici la partie chargtement des scripts :</p>
<div class='highlight'><pre><code class='html'><span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
<span class='nt'>&lt;script&gt;</span><span class='nb'>window</span><span class='p'>.</span><span class='nx'>jQuery</span> <span class='o'>||</span> <span class='nb'>document</span><span class='p'>.</span><span class='nx'>write</span><span class='p'>(</span><span class='s1'>&#39;&lt;script src=&quot;js/vendor/jquery.js&quot;&gt;&lt;\/script&gt;&#39;</span><span class='p'>)</span><span class='nt'>&lt;/script&gt;</span>

<span class='c'>&lt;!-- scripts concatenated and minified via build script --&gt;</span>
<span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;js/vendor/underscore.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
<span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;js/vendor/backbone.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
<span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;js/application.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
<span class='c'>&lt;!-- all your scripts here --&gt;</span>
<span class='c'>&lt;!-- end scripts --&gt;</span>
</code></pre>
</div>
<h3 id='templates_jst'>Templates JST</h3>

<p>Comme notre index.html est tout vide, il nous faudra gérer nos templates dans des fichiers séparés.</p>

<p>(J&#8217;ouvre une parenthèse, mais je préfère gérer mes templates HTML dans des fichiers séparés plutôt que de les inclure dans des balises script dans index.html)</p>

<p>Ce qu&#8217;il nous faut, c&#8217;est créer un fichier HTML, qui sera ensuite compilé en une fonction javascript, ce qui nous permettra de récupérer le texte dans notre application.</p>

<p>Je m&#8217;explique. Prenons un template <code>hello-world.jst</code></p>
<div class='highlight'><pre><code class='html'><span class='nt'>&lt;p&gt;</span>Hello <span class='nt'>&lt;/p&gt;</span>
</code></pre>
</div>
<p>Transformons <code>hello-world.jst</code> en <code>templates.js</code> :</p>
<div class='highlight'><pre><code class='javascript'><span class='nb'>window</span><span class='p'>.</span><span class='nx'>JST</span> <span class='o'>=</span> <span class='p'>{</span>
  <span class='s2'>&quot;hello-world&quot;</span><span class='o'>:</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>data</span><span class='p'>){</span> <span class='k'>return</span> <span class='s2'>&quot;&lt;p&gt;Hello &quot;</span> <span class='o'>+</span> <span class='nx'>data</span><span class='p'>.</span><span class='nx'>name</span> <span class='o'>+</span> <span class='s2'>&quot;&lt;/p&gt;&quot;</span> <span class='p'>}</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>Il nous suffira de rajouter <code>&lt;script src=&quot;template/templates.js&quot;&gt;&lt;/script&gt;</code> dans index.html et nous pourrons accéder à notre template n&#8217;importe où dans l&#8217;application à l&#8217;aide du namespace JST.</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>$</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(){</span>
    <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;body&#39;</span><span class='p'>).</span><span class='nx'>append</span><span class='p'>(</span><span class='nx'>JST</span><span class='p'>[</span><span class='s1'>&#39;hello-world&#39;</span><span class='p'>]({</span><span class='nx'>name</span><span class='o'>:</span> <span class='s1'>&#39;World&#39;</span><span class='p'>}));</span>
<span class='p'>})</span>
</code></pre>
</div>
<p>Mantenant vous avez compris le principe des JST. Si jamais ce n&#8217;est pas le cas, lisez cet article là <a href='http://ricostacruz.com/backbone-patterns/#jst_templates'>http://ricostacruz.com/backbone-patterns/#jst_templates</a>, ou les liens ci dessous.</p>

<p>Il existe de nombreuses solutions pour faire du JST dans votre application, mais, si vous souhaitez quelque chose qui fonctionne avec n&#8217;importe quel template (underscore template, jquery-tmpl, handlebars, des strings pures) jetez un oeil à ce projet <a href='https://github.com/Filirom1/universal-jst'>https://github.com/Filirom1/universal-jst</a> #auto-promotion :)</p>

<p>Sinon regardez les projets ci dessous :</p>

<ul>
<li><a href='http://github.com/wookiehangover/handlebars-jst'>http://github.com/wookiehangover/handlebars-jst</a></li>

<li><a href='http://github.com/wookiehangover/jquery-tmpl-jst'>http://github.com/wookiehangover/jquery-tmpl-jst</a></li>

<li><a href='http://github.com/mklabs/templatify'>http://github.com/mklabs/templatify</a></li>

<li><a href='http://documentcloud.github.com/jammit/#jst'>http://documentcloud.github.com/jammit/#jst</a></li>

<li><a href='http://github.com/sstephenson/sprockets'>http://github.com/sstephenson/sprockets</a></li>
</ul>

<h3 id='utilisation_dun_namespace'> Utilisation d&#8217;un Namespace</h3>

<p>Trouvez un nom court pour votre namespace qui n&#8217;est pas un mot clé réservé. Par exemple, DocumentCloud à choisi d&#8217;utiliser ses initiales : <code>dc</code></p>

<p>On défini le namespace au tout début de notre application, afin de pouvoir l&#8217;utiliser n&#8217;importe où par la suite.</p>

<p><a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/application.js'>application.js</a> :</p>
<div class='highlight'><pre><code class='javascript'><span class='c1'>// Provide top-level namespaces for our javascript.</span>
<span class='p'>(</span><span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
  <span class='nb'>window</span><span class='p'>.</span><span class='nx'>dc</span> <span class='o'>=</span> <span class='p'>{};</span>
  <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span> <span class='o'>=</span> <span class='p'>{};</span>         <span class='cm'>/* anything that is shared globally in the application */</span>
  <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span> <span class='o'>=</span> <span class='p'>{};</span>          <span class='cm'>/* views */</span>
  <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>model</span> <span class='o'>=</span> <span class='p'>{};</span>       <span class='cm'>/* models and collections */</span>
<span class='p'>})();</span>
</code></pre>
</div>
<p>Comme nous allons découper notre application en plein de petits fichiers, nous allons augmenter ce namespace dans chaque fichier:</p>

<p><a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/ui/workspace/panel.js'>js/ui/workspace/panel.js</a>:</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Panel</span> <span class='o'>=</span> <span class='nx'>Backbone</span><span class='p'>.</span><span class='nx'>View</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({</span>
  <span class='c1'>//...</span>
<span class='p'>});</span>
</code></pre>
</div>
<p><a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/ui/common/dialog.js'>js/ui/common/dialog.js</a> :</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Dialog</span> <span class='o'>=</span> <span class='nx'>Backbone</span><span class='p'>.</span><span class='nx'>View</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({</span>
      <span class='c1'>//...</span>
<span class='p'>});</span>
</code></pre>
</div>
<p><a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/model/documents.js'>js/model/documents.js</a> :</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>dc</span><span class='p'>.</span><span class='nx'>model</span><span class='p'>.</span><span class='nx'>Document</span> <span class='o'>=</span> <span class='nx'>Backbone</span><span class='p'>.</span><span class='nx'>Model</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({</span>
      <span class='c1'>//...</span>
<span class='p'>});</span>
</code></pre>
</div>
<p>En plus comme chacun de nos fichiers est contenu dans un objet, on ne risquera pas de pourrire la globale window ;) Plus besoin d&#8217;entourer notre code dans un fonction auto appelante :</p>
<div class='highlight'><pre><code class='javascript'><span class='c1'>// Before</span>
<span class='p'>(</span><span class='kd'>function</span><span class='p'>(){</span>
  <span class='cm'>/* your code here */</span>
<span class='p'>})()</span>
</code></pre>
</div>
<p>De plus maintenant, chacun de nos objets est facilement accessible via la console.</p>

<pre><code>$ console.log(new dc.model.Document());</code></pre>

<p>Ce qui est très pratique pour débugguer.</p>

<p>Comme vous allez beaucoup écrire ce namespace (ici <code>dc</code>), je vous conseil de choisir quelque chose de court. Deux lettres c&#8217;est bien.</p>

<h3 id='dpendances_et_initialisations'> Dépendances et initialisations</h3>

<p>Une des difficultés en Javascript c&#8217;est la gestion des dépendances entre les fichiers.</p>

<p>Dans le cas de notre application, il y a 2 sortes de dépendances :</p>

<ul>
<li>à la lecture du fichier, les variables doivent être connu par l&#8217;interpréteur JavaScript.</li>
</ul>

<p>Comme nos fichiers commenceront tous par <code>dc.xxx.xxxx = Backbone.XXXXX.extend({</code>, il sera facile pour nous de gérer l&#8217;ordre dans l&#8217;index.html afin qu&#8217;il n&#8217;y ai pas de problèmes de dépendances.</p>

<p>Les dépendances qui se trouvent à l&#8217;intérieur des fonctions (initialize, render&#8230;) seront résolues plus tard.</p>

<ul>
<li>lors de l&#8217;instantiation, si l&#8217;on fait appel à un module externe, celui ci doit avoir été instancié préalablement.</li>
</ul>

<p>Je m&#8217;explique, nous allons découper notre application en plein de petits fichiers. Une fois instancié ces modules vont communiquer entre eux. Mais on peut faire la distinction entre les modules qui seront utilisés par toute l&#8217;application et les modules qui ne seront utilisés que localement.</p>

<h4 id='dpendances_partages_globalement'>Dépendances partagées globalement</h4>

<p>Si on défini un module comme quelque chose pouvant être appelé par n&#8217;importe quel autre module dans l&#8217;application. Il est important d&#8217;instancier ces modules dans un ordre précis (un module peut dépendre d&#8217;un autre module), c&#8217;est pour cela que l&#8217;on instanciera ces modules dans une fichier unique, par exemple le routeur. Ces modules seront accessibles par toute l&#8217;application.</p>
<p class='center'>
  <img border='0' src='/public/img/2012-02-25-backbone-tips-from-document-cloud/dependences-globales.png' />
</p>
<p><a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/app/workspace.js'>js/app/workspace.js</a> :</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>Router</span> <span class='o'>=</span> <span class='nx'>Backbone</span><span class='p'>.</span><span class='nx'>Router</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({</span>

  <span class='nx'>routes</span> <span class='o'>:</span> <span class='p'>{</span>
    <span class='c1'>// ...</span>
  <span class='p'>},</span>

  <span class='nx'>initialize</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>createSubViews</span><span class='p'>();</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>renderSubViews</span><span class='p'>();</span>
  <span class='p'>},</span>

  <span class='nx'>createSubViews</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>paginator</span>  <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Paginator</span><span class='p'>();</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>navigation</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Navigation</span><span class='p'>();</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>toolbar</span>    <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Toolbar</span><span class='p'>();</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>organizer</span>  <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Organizer</span><span class='p'>();</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>notifier</span>    <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Notifier</span><span class='p'>();</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>tooltip</span>     <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Tooltip</span><span class='p'>();</span>
    <span class='c1'>// ...</span>
  <span class='p'>},</span>

  <span class='c1'>// Render all of the existing subviews and place them in the DOM.</span>
  <span class='nx'>renderSubViews</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
    <span class='kd'>var</span> <span class='nx'>content</span>   <span class='o'>=</span> <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#content&#39;</span><span class='p'>);</span>
    <span class='nx'>content</span><span class='p'>.</span><span class='nx'>append</span><span class='p'>(</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>sidebar</span><span class='p'>.</span><span class='nx'>render</span><span class='p'>().</span><span class='nx'>el</span><span class='p'>);</span>
    <span class='nx'>content</span><span class='p'>.</span><span class='nx'>append</span><span class='p'>(</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>panel</span><span class='p'>.</span><span class='nx'>render</span><span class='p'>().</span><span class='nx'>el</span><span class='p'>);</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>navigation</span><span class='p'>.</span><span class='nx'>render</span><span class='p'>();</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>hotkeys</span><span class='p'>.</span><span class='nx'>initialize</span><span class='p'>();</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>help</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Help</span><span class='p'>({</span><span class='nx'>el</span> <span class='o'>:</span> <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#help&#39;</span><span class='p'>)[</span><span class='mi'>0</span><span class='p'>]}).</span><span class='nx'>render</span><span class='p'>();</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>panel</span><span class='p'>.</span><span class='nx'>add</span><span class='p'>(</span><span class='s1'>&#39;search_box&#39;</span><span class='p'>,</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>searchBox</span><span class='p'>.</span><span class='nx'>render</span><span class='p'>().</span><span class='nx'>el</span><span class='p'>);</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>panel</span><span class='p'>.</span><span class='nx'>add</span><span class='p'>(</span><span class='s1'>&#39;pagination&#39;</span><span class='p'>,</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>paginator</span><span class='p'>.</span><span class='nx'>el</span><span class='p'>);</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>panel</span><span class='p'>.</span><span class='nx'>add</span><span class='p'>(</span><span class='s1'>&#39;search_toolbar&#39;</span><span class='p'>,</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>toolbar</span><span class='p'>.</span><span class='nx'>render</span><span class='p'>().</span><span class='nx'>el</span><span class='p'>);</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>panel</span><span class='p'>.</span><span class='nx'>add</span><span class='p'>(</span><span class='s1'>&#39;document_list&#39;</span><span class='p'>,</span> <span class='k'>this</span><span class='p'>.</span><span class='nx'>documentList</span><span class='p'>.</span><span class='nx'>render</span><span class='p'>().</span><span class='nx'>el</span><span class='p'>);</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>sidebar</span><span class='p'>.</span><span class='nx'>add</span><span class='p'>(</span><span class='s1'>&#39;entities&#39;</span><span class='p'>,</span> <span class='k'>this</span><span class='p'>.</span><span class='nx'>entityList</span><span class='p'>.</span><span class='nx'>render</span><span class='p'>().</span><span class='nx'>el</span><span class='p'>);</span>
    <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#no_results_container&#39;</span><span class='p'>).</span><span class='nx'>html</span><span class='p'>(</span><span class='nx'>JST</span><span class='p'>[</span><span class='s1'>&#39;workspace/no_results&#39;</span><span class='p'>]({}));</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>sidebar</span><span class='p'>.</span><span class='nx'>add</span><span class='p'>(</span><span class='s1'>&#39;organizer&#39;</span><span class='p'>,</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>organizer</span><span class='p'>.</span><span class='nx'>render</span><span class='p'>().</span><span class='nx'>el</span><span class='p'>);</span>
  <span class='p'>}</span>
<span class='p'>});</span>

<span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>router</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>MyRouter</span><span class='p'>();</span>
</code></pre>
</div>
<h4 id='dpendances_partages_hirarchiquement'>Dépendances partagées hiérarchiquement</h4>

<p>Dans une application, nous avons toujours besoin de découper des modules en sous modules et donc d&#8217;avoir une relation de dépendance entre les deux.</p>

<p>Mais comme cette relation est du type parent - enfant, ce sera toujours via le module parent que les enfants pourront discuté entre eux ou avec le parent.</p>
<p class='center'>
  <img border='0' src='/public/img/2012-02-25-backbone-tips-from-document-cloud/dependences-hierarchiques.png' />
</p>
<p>Nous allons donc attaché les instances des enfants au parent.</p>

<p><a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/app/editor.js'>js/app/editor</a> :</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>editor</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>Backbone</span><span class='p'>.</span><span class='nx'>View</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({</span>

  <span class='nx'>initialize</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>docId</span><span class='p'>,</span> <span class='nx'>options</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>createSubViews</span><span class='p'>();</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>renderSubViews</span><span class='p'>();</span>
  <span class='p'>},</span>
  
  <span class='nx'>createSubViews</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>controlPanel</span>       <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>ViewerControlPanel</span><span class='p'>();</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>sectionEditor</span>      <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>SectionEditor</span><span class='p'>();</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>annotationEditor</span>   <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>AnnotationEditor</span><span class='p'>();</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>removePagesEditor</span>  <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>RemovePagesEditor</span><span class='p'>({</span><span class='nx'>editor</span> <span class='o'>:</span> <span class='k'>this</span><span class='p'>});</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>reorderPagesEditor</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>ReorderPagesEditor</span><span class='p'>({</span><span class='nx'>editor</span> <span class='o'>:</span> <span class='k'>this</span><span class='p'>});</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>editPageTextEditor</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>EditPageTextEditor</span><span class='p'>({</span><span class='nx'>editor</span> <span class='o'>:</span> <span class='k'>this</span><span class='p'>});</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>replacePagesEditor</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>ReplacePagesEditor</span><span class='p'>({</span><span class='nx'>editor</span> <span class='o'>:</span> <span class='k'>this</span><span class='p'>});</span>
  <span class='p'>},</span>
</code></pre>
</div>
<p>Regardez également comment le module parent partage son instance avec ses enfants : <code>new dc.ui.ReplacePagesEditor({editor : this})</code>. C&#8217;est ainsi que les enfants peuvent discuter avec le module parent, ou discuter avec les autres enfants.</p>

<h4 id='remarque_sur_requirejs'>Remarque sur RequireJS</h4>

<p>Si pendant la lecture de ce paragraphe vous vous dites que vous n&#8217;avez pas besoin de tout ça car vous avez RequireJs. Sachez que lorsque vous définissez un module avec RequireJs, vous avez le choix entre retourner une classe, ou un singleton, mais faire les deux devient problématique. Vous aurez donc solutionné un problème, mais pas les deux.</p>

<p>MyModel.js :</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>define</span><span class='p'>([</span><span class='s1'>&#39;jquery&#39;</span><span class='p'>,</span> <span class='s1'>&#39;backbone&#39;</span><span class='p'>],</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>$</span><span class='p'>,</span> <span class='nx'>Backbone</span><span class='p'>){</span>
    <span class='k'>return</span> <span class='nx'>Backbone</span><span class='p'>.</span><span class='nx'>Model</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({});</span> <span class='c1'>// classe</span>
<span class='p'>})</span>
</code></pre>
</div>
<p>MyCollection.js :</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>define</span><span class='p'>([</span><span class='s1'>&#39;jquery&#39;</span><span class='p'>,</span> <span class='s1'>&#39;backbone&#39;</span><span class='p'>,</span> <span class='s1'>&#39;MyModel&#39;</span><span class='p'>],</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>$</span><span class='p'>,</span> <span class='nx'>Backbone</span><span class='p'>,</span> <span class='nx'>MyModel</span><span class='p'>){</span>
    <span class='kd'>var</span> <span class='nx'>Collection</span> <span class='o'>=</span> <span class='nx'>Backbone</span><span class='p'>.</span><span class='nx'>Collection</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({</span>
        <span class='nx'>model</span><span class='o'>:</span> <span class='nx'>MyModel</span>
    <span class='p'>});</span>
    <span class='k'>return</span> <span class='k'>new</span> <span class='nx'>Collection</span><span class='p'>();</span> <span class='c1'>// singleton</span>
<span class='p'>})</span>
</code></pre>
</div>
<h3 id='communication_entre_modules'>Communication entre modules.</h3>

<p>Le plus simple pour faire communiquer deux modules entre eux, c&#8217;est de les faire interagir directement.</p>

<p>Prenons un exemple, ici le module Document communique directement avec le module Searcher.</p>

<p><a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/ui/documents/document.js'>js/ui/documents/document.js</a> :</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Document</span> <span class='o'>=</span> <span class='nx'>Backbone</span><span class='p'>.</span><span class='nx'>View</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({</span>
  <span class='c1'>// ...</span>

  <span class='nx'>searchAccount</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>searcher</span><span class='p'>.</span><span class='nx'>addToSearch</span><span class='p'>(</span><span class='s1'>&#39;account&#39;</span><span class='p'>,</span> <span class='k'>this</span><span class='p'>.</span><span class='nx'>model</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='s1'>&#39;account_slug&#39;</span><span class='p'>));</span>
  <span class='p'>},</span>

  <span class='nx'>searchOrganization</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>searcher</span><span class='p'>.</span><span class='nx'>addToSearch</span><span class='p'>(</span><span class='s1'>&#39;group&#39;</span><span class='p'>,</span> <span class='k'>this</span><span class='p'>.</span><span class='nx'>model</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='s1'>&#39;organization_slug&#39;</span><span class='p'>));</span>
  <span class='p'>},</span>

  <span class='nx'>searchSource</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>app</span><span class='p'>.</span><span class='nx'>searcher</span><span class='p'>.</span><span class='nx'>addToSearch</span><span class='p'>(</span><span class='s1'>&#39;source&#39;</span><span class='p'>,</span> <span class='k'>this</span><span class='p'>.</span><span class='nx'>model</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='s1'>&#39;source&#39;</span><span class='p'>).</span><span class='nx'>replace</span><span class='p'>(</span><span class='sr'>/&quot;/g</span><span class='p'>,</span> <span class='s1'>&#39;\\&quot;&#39;</span><span class='p'>));</span>
  <span class='p'>},</span>

<span class='p'>});</span>
</code></pre>
</div>
<p>Je vous entends crier au loin, mais c&#8217;est fortement coupler ça !!!</p>

<p>Comme il n&#8217;y a pas de typage fort en javascript vous vous en moquez! C&#8217;est comme si vous utilisiez des interfaces en Java. Si vous voulez remplacer un module par un autre, il suffit que les deux modules possèdent les mêmes signatures de fonctions et vous pouvez les remplacer.</p>

<p>Maintenant si vous voulez savoir quelles sont les fonctions publiques et les fonctions privées, je vous déconseille de les préfixer par un undercsore. Déjà, c&#8217;est moche et en plus c&#8217;est inutile car un simple grep suffit pour savoir quelles sont les méthodes publiques :</p>

<pre><code>$ grep -R &quot;replacePagesEditor\.&quot; .
./public/javascripts/ui/workspace/toolbar.js:    dc.app.editor.replacePagesEditor.open(); 
./public/javascripts/editor/control_panel.js:    dc.app.editor.replacePagesEditor.toggle();
./public/javascripts/app/editor.js:              this.replacePagesEditor.close();</code></pre>

<p>Après vous pouvez communiquer via des événements, mais il faudra un peu plus de travail pour synchroniser plusieurs événements. De plus, les appels seront moins facile à repérer dans le code.</p>

<p>Le problème avec les événements en JS, c&#8217;est que l&#8217;on perd vite le contrôle de l&#8217;application et tout parait magique.</p>

<p>Je ne vous interdit pas d&#8217;utiliser les événement, mais faîtes le avec parcimonie et justesse.</p>

<h3 id='utiliser_le_modle_objet'> Utiliser le modèle objet</h3>

<p>Quand vous utilisez Backbone, vous créez des classes filles de Backbone.View, Backbone.Model, Backbone.Collection, &#8230;</p>

<p>Alors pourquoi ne pas créer ses propres classe mère :</p>

<p><a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/ui/accounts/account_dialog.js'>js/ui/accounts/account_dialog.js</a> :</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>AccountDialog</span> <span class='o'>=</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Dialog</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({</span>

  <span class='nx'>constructor</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Dialog</span><span class='p'>.</span><span class='nx'>call</span><span class='p'>(</span><span class='k'>this</span><span class='p'>,</span> <span class='p'>{...}</span> <span class='p'>);</span>
    <span class='c1'>// ...</span>
  <span class='p'>},</span>

  <span class='nx'>render</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
    <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Dialog</span><span class='p'>.</span><span class='nx'>prototype</span><span class='p'>.</span><span class='nx'>render</span><span class='p'>.</span><span class='nx'>call</span><span class='p'>(</span><span class='k'>this</span><span class='p'>);</span>
    <span class='c1'>// ...</span>
  <span class='p'>}</span>
</code></pre>
</div>
<p>Ou bien créer des factories :</p>

<p><a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/ui/common/dialog.js'>js/ui/common/dialog.js</a> :</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>_</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>(</span><span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Dialog</span><span class='p'>,</span> <span class='p'>{</span>

  <span class='nx'>alert</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>text</span><span class='p'>,</span> <span class='nx'>options</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>return</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>ui</span><span class='p'>.</span><span class='nx'>Dialog</span><span class='p'>(</span><span class='nx'>_</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({</span>
      <span class='nx'>mode</span>      <span class='o'>:</span> <span class='s1'>&#39;alert&#39;</span><span class='p'>,</span>
      <span class='nx'>title</span>     <span class='o'>:</span> <span class='kc'>null</span><span class='p'>,</span>
      <span class='nx'>text</span>      <span class='o'>:</span> <span class='nx'>text</span>
    <span class='p'>},</span> <span class='nx'>options</span><span class='p'>)).</span><span class='nx'>render</span><span class='p'>();</span>
  <span class='p'>},</span>
</code></pre>
</div>
<p>Ou même, améliorer nos classes à l&#8217;aide de mixins</p>

<p><a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/model/documents.js'>js/model/documents.js</a> :</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>_</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>(</span><span class='nx'>dc</span><span class='p'>.</span><span class='nx'>model</span><span class='p'>.</span><span class='nx'>DocumentSet</span><span class='p'>.</span><span class='nx'>prototype</span><span class='p'>,</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>model</span><span class='p'>.</span><span class='nx'>Selectable</span><span class='p'>);</span>
</code></pre>
</div>
<h3 id='des_vues_limites__une_petite_portion_du_dom'> Des vues limitées à une petite portion du DOM</h3>

<p>Une des choses les plus belles avec Backbone c&#8217;est l&#8217;attribut <code>this.el</code>, et les nombreuses utilisations : <code>this.$el</code>, <code>this.$</code>, &#8230; Utiliser <code>el</code> vous permet de limiter l&#8217;interaction qui vous aurez avec le DOM. Non seulement vous gagnez en performance (les sélecteurs jQuery sont précis) mais en plus cela vous empêche de modifier des éléments qui n&#8217;appartiennent pas à votre vue.</p>
<p class='center'>
  <img border='0' src='/public/img/2012-02-25-backbone-tips-from-document-cloud/DocumentCloud.png' width='600' />
</p>
<p>Alors vous l&#8217;aurez compris, je ne veux plus voir de <code>$</code> dans vos applications Backbone, seulement des <code>this.$</code> :D</p>

<h3 id='des_conventions_qui_rendent_la_lecture_du_code_tellement_plus_agrable'> Des conventions qui rendent la lecture du code tellement plus agréable.</h3>

<p>Il y a une autre chose que j&#8217;aime dans Backbone, ce sont ses conventions. Par exemple dans une vue, on repère instantanément les interactions utilisateurs :</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>events</span> <span class='o'>:</span> <span class='p'>{</span>
  <span class='s1'>&#39;keydown #search_box&#39;</span><span class='o'>:</span>   <span class='s1'>&#39;maybeSearch&#39;</span><span class='p'>,</span>
  <span class='s1'>&#39;search #search_box&#39;</span><span class='o'>:</span>    <span class='s1'>&#39;search&#39;</span><span class='p'>,</span>
  <span class='s1'>&#39;focus #search_box&#39;</span><span class='o'>:</span>     <span class='s1'>&#39;addFocus&#39;</span><span class='p'>,</span>
  <span class='s1'>&#39;blur #search_box&#39;</span><span class='o'>:</span>      <span class='s1'>&#39;removeFocus&#39;</span><span class='p'>,</span>
  <span class='s1'>&#39;click .cancel_search&#39;</span><span class='o'>:</span>  <span class='s1'>&#39;cancelSearch&#39;</span><span class='p'>,</span>
  <span class='s1'>&#39;click #login_button&#39;</span><span class='o'>:</span>   <span class='s1'>&#39;login&#39;</span>
<span class='p'>},</span>
</code></pre>
</div>
<p>Mais vous pouvez faire la même chose partout, choisir des conventions et s&#8217;y tenir. Par exemple, mettre les constantes et haut et en majuscule :)</p>

<pre><code>Backbone.View.extend({
    FAVORITES_URL : &#39;//twitter.com/favorites/documentcloud.json?callback=?&#39;,</code></pre>

<h3 id='crer_des_plugins_backbone'>Créer des plugins Backbone</h3>

<p>Tout le monde connait les plugins jQuery. Mais saviez vous que vous pouvez faire la même chose avec Backbone?</p>

<p>Par exemple, dans DocumentCloud il y a un plugin bien pratique le <code>setMode</code>. SetMode permet de gérer une machine à état au niveau des vues. Lorsque l&#8217;on fait un setMode, on ajoute une classe CSS sur le <code>el</code> de la vue (pratique pour le CSS) et on ajoute un attribut à l&#8217;instance de la vue afin de faciliter les interactions inter-modules.</p>

<p>Je sens que vous ne m&#8217;avez pas bien compris, voici un exemple:</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>xxx</span><span class='p'>.</span><span class='nx'>setMode</span><span class='p'>(</span><span class='s1'>&#39;is&#39;</span><span class='p'>,</span> <span class='s1'>&#39;draggable&#39;</span><span class='p'>);</span>

<span class='c1'>// xxx.el === &#39;&lt;div class=&quot;is_draggable&quot;&gt;&lt;/div&gt;&#39;</span>
<span class='c1'>// xxx.modes === {draggable: &#39;is&#39;}</span>

<span class='nx'>xxx</span><span class='p'>.</span><span class='nx'>setMode</span><span class='p'>(</span><span class='s1'>&#39;prompt&#39;</span><span class='p'>,</span> <span class='s1'>&#39;dialog&#39;</span><span class='p'>);</span>
<span class='nx'>xxx</span><span class='p'>.</span><span class='nx'>setMode</span><span class='p'>(</span><span class='s1'>&#39;isnot&#39;</span><span class='p'>,</span> <span class='s1'>&#39;draggable&#39;</span><span class='p'>);</span>

<span class='c1'>// xxx.el === &#39;&lt;div class=&quot;isnot_draggable prompt_dialog&quot;&gt;&lt;/div&gt;&#39;</span>
<span class='c1'>// xxx.modes === {draggable: &#39;isnot&#39;, dialog: &#39;prompt&#39;}</span>
</code></pre>
</div>
<p><a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/lib/backbone_extensions.js'>js/lib/backbone_extensions.js</a>:</p>
<div class='highlight'><pre><code class='javascript'><span class='c1'>// Makes the view enter a mode. Modes have both a &#39;mode&#39; and a &#39;group&#39;,</span>
<span class='c1'>// and are mutually exclusive with any other modes in the same group.</span>
<span class='c1'>// Setting will update the view&#39;s modes hash, as well as set an HTML class</span>
<span class='c1'>// of *[mode]_[group]* on the view&#39;s element. Convenient way to swap styles</span>
<span class='c1'>// and behavior.</span>
<span class='nx'>Backbone</span><span class='p'>.</span><span class='nx'>View</span><span class='p'>.</span><span class='nx'>prototype</span><span class='p'>.</span><span class='nx'>setMode</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>mode</span><span class='p'>,</span> <span class='nx'>group</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='k'>this</span><span class='p'>.</span><span class='nx'>modes</span> <span class='o'>||</span> <span class='p'>(</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>modes</span> <span class='o'>=</span> <span class='p'>{});</span>
  <span class='k'>if</span> <span class='p'>(</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>modes</span><span class='p'>[</span><span class='nx'>group</span><span class='p'>]</span> <span class='o'>===</span> <span class='nx'>mode</span><span class='p'>)</span> <span class='k'>return</span><span class='p'>;</span>
  <span class='nx'>$</span><span class='p'>(</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>el</span><span class='p'>).</span><span class='nx'>setMode</span><span class='p'>(</span><span class='nx'>mode</span><span class='p'>,</span> <span class='nx'>group</span><span class='p'>);</span>
  <span class='k'>this</span><span class='p'>.</span><span class='nx'>modes</span><span class='p'>[</span><span class='nx'>group</span><span class='p'>]</span> <span class='o'>=</span> <span class='nx'>mode</span><span class='p'>;</span>
<span class='p'>};</span>
</code></pre>
</div>
<p><a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/lib/jquery_extensions.js'>js/lib/jquery_extensions.js</a>:</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>$</span><span class='p'>.</span><span class='nx'>fn</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({</span>
  <span class='c1'>// See Backbone.View#setMode...</span>
  <span class='nx'>setMode</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>state</span><span class='p'>,</span> <span class='nx'>group</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>group</span> <span class='o'>=</span> <span class='nx'>group</span> <span class='o'>||</span> <span class='s1'>&#39;mode&#39;</span><span class='p'>;</span>
    <span class='kd'>var</span> <span class='nx'>re</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nb'>RegExp</span><span class='p'>(</span><span class='s2'>&quot;\\w+_&quot;</span> <span class='o'>+</span> <span class='nx'>group</span> <span class='o'>+</span> <span class='s2'>&quot;(\\s|$)&quot;</span><span class='p'>,</span> <span class='s1'>&#39;g&#39;</span><span class='p'>);</span>
    <span class='kd'>var</span> <span class='nx'>mode</span> <span class='o'>=</span> <span class='p'>(</span><span class='nx'>state</span> <span class='o'>===</span> <span class='kc'>null</span><span class='p'>)</span> <span class='o'>?</span> <span class='s2'>&quot;&quot;</span> <span class='o'>:</span> <span class='nx'>state</span> <span class='o'>+</span> <span class='s2'>&quot;_&quot;</span> <span class='o'>+</span> <span class='nx'>group</span><span class='p'>;</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>each</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(){</span>
      <span class='k'>this</span><span class='p'>.</span><span class='nx'>className</span> <span class='o'>=</span> <span class='p'>(</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>className</span><span class='p'>.</span><span class='nx'>replace</span><span class='p'>(</span><span class='nx'>re</span><span class='p'>,</span> <span class='s1'>&#39;&#39;</span><span class='p'>)</span> <span class='o'>+</span> <span class='s1'>&#39; &#39;</span> <span class='o'>+</span> <span class='nx'>mode</span><span class='p'>).</span><span class='nx'>replace</span><span class='p'>(</span><span class='sr'>/\s\s/g</span><span class='p'>,</span> <span class='s1'>&#39; &#39;</span><span class='p'>);</span>
    <span class='p'>});</span>
    <span class='k'>return</span> <span class='nx'>mode</span><span class='p'>;</span>
  <span class='p'>},</span>
<span class='p'>})</span>
</code></pre>
</div>
<h3 id='ne_pas_se_limiter__lutilisation_classique_de_backbone'> Ne pas se limiter à l&#8217;utilisation classique de Backbone</h3>

<p>Backbone est suffisamment petit pour que n&#8217;importe quel développeur se sente à l&#8217;aise avec les sources. Franchement c&#8217;est tellement rare ça alors profitez en !</p>

<p>Vous pouvez avoir une utilisation minimaliste de Backbone.</p>

<p>Regarder par exemple la HomePage de DocumentCloud <a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/home/home.js'>https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/home/home.js</a></p>

<p>Ou bien le modèle Documents de Backbone <a href='https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/model/documents.js'>https://github.com/lyonjs/documentcloud/blob/master/public/javascripts/model/documents.js</a>.</p>

<p>Vous verrez que si vous n&#8217;utilisez le modèle qu&#8217;en lecture seule, vous pourrez le synchroniser bien plus simplement :</p>
<div class='highlight'><pre><code class='javascript'><span class='c1'>// Fetch all of the documents page mentions for a given search query.</span>
<span class='nx'>fetchMentions</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>query</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='nx'>$</span><span class='p'>.</span><span class='nx'>getJSON</span><span class='p'>(</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>url</span><span class='p'>()</span> <span class='o'>+</span> <span class='s1'>&#39;/mentions&#39;</span><span class='p'>,</span> <span class='p'>{</span><span class='nx'>q</span><span class='o'>:</span> <span class='nx'>query</span><span class='p'>},</span> <span class='nx'>_</span><span class='p'>.</span><span class='nx'>bind</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>resp</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>set</span><span class='p'>(</span><span class='nx'>resp</span><span class='p'>);</span>
  <span class='p'>},</span> <span class='k'>this</span><span class='p'>));</span>
<span class='p'>},</span> 

<span class='c1'>// Tell the server to reprocess the text for this document.</span>
<span class='nx'>reprocessText</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>forceOCR</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='kd'>var</span> <span class='nx'>params</span> <span class='o'>=</span> <span class='p'>{};</span>
  <span class='k'>if</span> <span class='p'>(</span><span class='nx'>forceOCR</span><span class='p'>)</span> <span class='nx'>params</span><span class='p'>.</span><span class='nx'>ocr</span> <span class='o'>=</span> <span class='kc'>true</span><span class='p'>;</span>
  <span class='nx'>$</span><span class='p'>.</span><span class='nx'>ajax</span><span class='p'>({</span><span class='nx'>url</span> <span class='o'>:</span> <span class='k'>this</span><span class='p'>.</span><span class='nx'>url</span><span class='p'>()</span> <span class='o'>+</span> <span class='s1'>&#39;/reprocess_text&#39;</span><span class='p'>,</span> <span class='nx'>data</span><span class='o'>:</span> <span class='nx'>params</span><span class='p'>,</span> <span class='nx'>type</span> <span class='o'>:</span> <span class='s1'>&#39;POST&#39;</span><span class='p'>,</span> <span class='nx'>dataType</span> <span class='o'>:</span> <span class='s1'>&#39;json&#39;</span><span class='p'>,</span> <span class='nx'>success</span> <span class='o'>:</span> <span class='nx'>_</span><span class='p'>.</span><span class='nx'>bind</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>resp</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>set</span><span class='p'>({</span><span class='nx'>access</span> <span class='o'>:</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>access</span><span class='p'>.</span><span class='nx'>PENDING</span><span class='p'>});</span>
  <span class='p'>},</span> <span class='k'>this</span><span class='p'>)});</span>
<span class='p'>},</span>
</code></pre>
</div>
<h3 id='dcouper_tout_en_petit_morceau'> Découper tout en petit morceau.</h3>

<p>Je vous ai déjà dis que vous deviez découper vos vues en sous vues afin de ne travailler que sur des toutes petites portions du DOM. Mais vous pouvez, et devrez faire de même avec les modèles.</p>

<p>Lorsque l&#8217;on récupère un modèle à partir d&#8217;un JSON, on récupère un gros bloc d&#8217;un coup qu&#8217;il va falloir découper.</p>

<p>Ici prenons l&#8217;exemple d&#8217;un document contenant une liste d&#8217;annotations :</p>
<div class='highlight'><pre><code class='javascript'><span class='p'>{</span>
  <span class='s2'>&quot;name&quot;</span><span class='o'>:</span> <span class='s2'>&quot;document 1&quot;</span><span class='p'>,</span>
  <span class='s2'>&quot;author&quot;</span><span class='o'>:</span> <span class='s2'>&quot;white house&quot;</span><span class='p'>,</span>
  <span class='s2'>&quot;annotations&quot;</span><span class='o'>:</span> <span class='p'>[{</span>
    <span class='s2'>&quot;line&quot;</span><span class='o'>:</span> <span class='mi'>154</span><span class='p'>,</span>
    <span class='s2'>&quot;text&quot;</span><span class='o'>:</span> <span class='s2'>&quot;it&#39;s true&quot;</span>
  <span class='p'>},</span> <span class='p'>{</span>
    <span class='s2'>&quot;line&quot;</span><span class='o'>:</span> <span class='mi'>156</span><span class='p'>,</span>
    <span class='s2'>&quot;text&quot;</span><span class='o'>:</span> <span class='s2'>&quot;it&#39;s false&quot;</span>
  <span class='p'>}]</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>Nous allons sortir les annotations du document afin de les gérer indépendamment.</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>dc</span><span class='p'>.</span><span class='nx'>model</span><span class='p'>.</span><span class='nx'>Document</span> <span class='o'>=</span> <span class='nx'>Backbone</span><span class='p'>.</span><span class='nx'>Model</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({</span>

  <span class='nx'>constructor</span> <span class='o'>:</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>attrs</span><span class='p'>,</span> <span class='nx'>options</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>notes</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>dc</span><span class='p'>.</span><span class='nx'>model</span><span class='p'>.</span><span class='nx'>NoteSet</span><span class='p'>();</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>notes</span><span class='p'>.</span><span class='nx'>url</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
      <span class='k'>return</span> <span class='s1'>&#39;/documents/&#39;</span> <span class='o'>+</span> <span class='nx'>id</span> <span class='o'>+</span> <span class='s1'>&#39;/annotations&#39;</span><span class='p'>;</span>
    <span class='p'>};</span>
    <span class='k'>if</span> <span class='p'>(</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='s1'>&#39;annotations&#39;</span><span class='p'>))</span> 
       <span class='k'>this</span><span class='p'>.</span><span class='nx'>notes</span><span class='p'>.</span><span class='nx'>reset</span><span class='p'>(</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='s1'>&#39;annotations&#39;</span><span class='p'>));</span>
</code></pre>
</div>
<p>Souvent vous aurez besoin de lier les événements du sous-modèle avec le modèle. Il faudra le faire à la main, mais toute la démarche est bien expliquée sur le site officiel : <a href='http://documentcloud.github.com/backbone/#FAQ-nested'>http://documentcloud.github.com/backbone/#FAQ-nested</a>. Ce n&#8217;est pas trop difficile à faire et tout est très logique.</p>

<h3 id='et_pour_finir__la_minification_de_vos_fichier_js'>Et pour finir : la minification de vos fichier JS.</h3>

<p>Vous n&#8217;alliez pas mettre en prod votre application avec tout ces petits fichiers &#8230;</p>

<p>Comme nous n&#8217;avons pas utilisé de loader javascript vous être entièrement libre de choisir le minifieur JS que vous voulez. Et c&#8217;est un luxe ça !!!</p>

<p>Si vous n&#8217;avez pas de Backend, choisissez plutôt un des <a href='http://html5boilerplate.com/docs/Build-script/'>builds scripts de HTML5BoilerPlate</a>.</p>

<p>Si vous utilisez un Backend en JAVA, <a href='http://code.google.com/p/wro4j/'>Wro4J</a> est un projet sérieux que vous pouvez utiliser sans risque.</p>

<p>Et n&#8217;oubliez pas de servir vos assets JS et CSS avec la compression GZIP activé :)</p>
  <footer>
    <section class="tags">
      <span>Tags :</span>
<ul>
  
    <li>
        <a href="tags.html#backbonejs" title="Voir les posts ayant le tag backbonejs">backbonejs</a>
    </li>
  
    <li>
        <a href="tags.html#javascript" title="Voir les posts ayant le tag javascript">javascript</a>
    </li>
  
    <li>
        <a href="tags.html#webapp" title="Voir les posts ayant le tag webapp">webapp</a>
    </li>
  
    <li>
        <a href="tags.html#spa" title="Voir les posts ayant le tag spa">spa</a>
    </li>
  
</ul>

    </section>
    <section id="disqus_thread" class="comments">
      <script type="text/javascript">
  var disqus_shortname = 'pullrequest';
  var disqus_identifier = '/2012/02/25/backbone-tips-from-document-cloud';
  $.getScript("http://pullrequest.disqus.com/embed.js");
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus</a>.</noscript>

    </section>
  </footer>
</article>

      </section><!--

   --><aside>
        <section id="about">
          <h1>A propos</h1>
          <p>PullRequest est un blog de développeurs ouvert à toute contribution appropriée.</p>
        </section>
        <section id="follow">
          <h1>Suivez nous!</h1>
          <ul>
            <li>
              <a href="http://twitter.com/pullrequest" class="twitter-follow-button" data-show-count="false" data-lang="fr">Follow @pullrequest</a>
              <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
            </li>
            <li class="feed">
              <a rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/pullrequest/blog-posts">abonnement RSS</a>
            </li>
          </ul>
        </section>
        <section id="contribute">
          <h1>Participer</h1>
          <p>
            Les articles sont écrits en <a href="http://daringfireball.net/projects/markdown/syntax">MarkDown</a> et stockés dans un repository Git sur <a href="http://github.com/pullrequest/pullrequest.github.com">Github</a>.
            N'hésitez pas à <strong>forker</strong> puis à faire une <strong><a href="https://github.com/pullrequest/pullrequest.github.com/pull/new/master">Pull Request</a></strong> ;)
          </p>
        </section>
        <section id="licensing">
          <h1>Licence</h1>
          <p>
            Les articles sont mis à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by/2.0/fr/">Licence Creative Commons Paternité 2.0 France</a>.
            <a rel="license" href="http://creativecommons.org/licenses/by/2.0/fr/">
              <br><img alt="Contrat Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by/2.0/fr/88x31.png" />
            </a>
          </p>
        </section>
        <section id="opensource">
          <h1>OpenSource</h1>
          <p>Les auteurs de PullRequest sont à l'origine, ou contributeurs, entre autres, de ces projets:</p>
          <ul>
            <li><a href="http://openscales.org">OpenScales</a></li>
            <li><a href="http://resthub.org">RestHub</a></li>
            <li><a href="https://github.com/loicfrering/LosoBundle">LosoBundle</a></li>
            <li><a href="https://github.com/loicfrering/losolib">LoSoLib</a></li>
            <li><a href="https://bitbucket.org/feugy/myth">Myth</a></li>
          </ul>
        </section>
      </aside>

    </div>

    <footer>
      <small id="legal">© 2011 pullrequest.org</small>
      <small id="poweredby">Propulsé par <a href="http://jekyllrb.com">Jekyll</a></small>
    </footer>
  </div>

  <script defer src="/public/js/tags.js"></script>
  <script defer src="/public/js/authors.js"></script>

  <script>
    var _gaq=[["_setAccount","UA-22833612-1"],["_trackPageview"]];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
    g.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js";
    s.parentNode.insertBefore(g,s)}(document,"script"));
  </script>

  <!--[if lt IE 7 ]>
  <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
  <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

</body>
</html>
