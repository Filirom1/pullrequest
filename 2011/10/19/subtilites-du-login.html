<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>.::PullRequest.org::. Les subtilités des formulaires de login en JS</title>
  <meta name="description" content="">
  <meta name="author" content="PullRequest team">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="/public/css/style.css">
  <link rel="stylesheet" href="/public/css/syntax.css">

  <script src="/public/js/libs/modernizr.custom.47336.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="/public/js/libs/jquery-1.6.2.min.js"><\/script>')</script>
</head>

<body>

  <div id="container">
    <header>
      <h1><a href="/" title="Page d'accueil"><img src="/public/img/pullrequest-logo.png" alt="PullRequest"/></a></h1>
      <a href="http://github.com/pullrequest"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 1;" src="https://a248.e.akamai.net/assets.github.com/img/abad93f42020b733148435e2cd92ce15c542d320/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub"></a>
    </header>

    <div id="main" role="main">
      <section id="content">
        
<article>
  <header>
    <h1><a href="/2011/10/19/subtilites-du-login.html">Les subtilités des formulaires de login en JS</a></h1>
    <p>
      <time datetime="2011-10-19" pubdate="pubdate">19 Oct 2011</time>
      <span class="author"><a href="/authors.html#feugy">Damien Feugas</a></span>
      <span class="comments"><a href="#disqus_thread" title="Voir les commentaires">Commentaires</a></span>
    </p>
  </header>
  <p>Quoi de plus simple qu&#8217;un formulaire de login ? En HTML, certes, mais lorsque qu&#8217;on parle d&#8217;application riche en javascript, c&#8217;est une autre histoire.</p>

<p>Si vous ne comprenez pas pourquoi le navigateur ne retient pas vos logins, ne propose pas le mot de passe associé, ou ne réagit pas à la touche entrée, lisez la suite !</p>

<p>Cet article est le résultat de <strong>l&#8217;étude empirique du comportement des navigateurs</strong>. Il est donc sujet à caution: tout dépends de votre navigateur et de sa version. J&#8217;espère simplement vous aider à comprendre et éviter les principaux chausse-trappes, sans avoir recours à l&#8217;installation d&#8217;un plugin :)</p>

<h2 id='mais_ce_nest_quun_formulaire_'>Mais ce n&#8217;est qu&#8217;un formulaire !</h2>

<p>Hélas non&#8230; Les formulaires de login (un champs <tt>text</tt> + un champ <tt>password</tt>) sont détectés par le navigateur, qui va les traiter différemment des autres champs textuels.</p>

<p>C&#8217;est là le premier problème :</p>

<blockquote>
<p><strong>Le formulaire doit être présent dans le DOM au chargement de la page.</strong></p>
</blockquote>

<p>Oui, vous avez compris : si vous construisez votre formulaire directement en JS, ou si vous utilisez un template que vous accrochez une fois la page chargée, votre formulaire sera ignoré par certains navigateurs.</p>

<p>L&#8217;astuce que j&#8217;utilise consiste à:</p>

<ul>
<li>inclure le formulaire de login dans ma page index.html</li>

<li>le masquer avec un style CSS <tt>display:none</tt>.</li>

<li>le déplacer par la suite en javascript là où il doit apparaitre dans le rendu</li>
</ul>

<p><strong>index.html</strong></p>
<div class='highlight'><pre><code class='html'><span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;loginStock&quot;</span> <span class='na'>style=</span><span class='s'>&quot;display:none&quot;</span><span class='nt'>&gt;</span>
    <span class='nt'>&lt;form</span> <span class='na'>id=</span><span class='s'>&quot;formLogin&quot;</span><span class='nt'>&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;username&quot;</span><span class='nt'>/&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;password&quot;</span> <span class='na'>name=</span><span class='s'>&quot;password&quot;</span><span class='nt'>/&gt;</span>
    <span class='nt'>&lt;/form&gt;</span>
<span class='nt'>&lt;/div&gt;</span>
</code></pre>
</div>
<p><strong>login.js</strong></p>
<div class='highlight'><pre><code class='js'><span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;.loginContainer&#39;</span><span class='p'>,</span> <span class='k'>this</span><span class='p'>.</span><span class='nx'>element</span><span class='p'>).</span><span class='nx'>append</span><span class='p'>(</span><span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#loginStock &gt; *&#39;</span><span class='p'>));</span>
</code></pre>
</div>
<h2 id='doisje_mettre_un_champ_de_type__'>Dois-je mettre un champ de type <tt>submit</tt> ?</h2>

<p>S&#8217;il n&#8217;y a que les champs de type <tt>text</tt> et <tt>password</tt>, le navigateur ne retiendra pas le mot de passe.</p>

<blockquote>
<p><strong>Le champ de type <tt>submit</tt> est indispensable.</strong></p>
</blockquote>

<p>Même s&#8217;il est masqué (le bouton n&#8217;est pas encore bien skinnable, même en CSS 3), il doit être présent.</p>

<p><strong>index.html</strong></p>
<div class='highlight'><pre><code class='html'><span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;loginStock&quot;</span> <span class='na'>style=</span><span class='s'>&quot;display:none&quot;</span><span class='nt'>&gt;</span>
    <span class='nt'>&lt;form</span> <span class='na'>id=</span><span class='s'>&quot;formLogin&quot;</span><span class='nt'>&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;username&quot;</span><span class='nt'>/&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;password&quot;</span> <span class='na'>name=</span><span class='s'>&quot;password&quot;</span><span class='nt'>/&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;submit&quot;</span> <span class='na'>style=</span><span class='s'>&quot;display:none&quot;</span><span class='nt'>/&gt;</span>
    <span class='nt'>&lt;/form&gt;</span>
    <span class='nt'>&lt;a</span> <span class='na'>href=</span><span class='s'>&quot;#&quot;</span> <span class='na'>class=</span><span class='s'>&quot;submit&quot;</span><span class='nt'>&gt;&lt;/a&gt;</span>
<span class='nt'>&lt;/div&gt;</span>
</code></pre>
</div>
<p><strong>login.js</strong></p>
<div class='highlight'><pre><code class='js'><span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;.loginContainer .submit&#39;</span><span class='p'>).</span><span class='nx'>click</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>event</span><span class='p'>){</span>
    <span class='c1'>// Déclenche la soumission du formulaire.</span>
    <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#formLogin&#39;</span><span class='p'>).</span><span class='nx'>submit</span><span class='p'>();</span>
    <span class='c1'>// Annule la propagation du Click sur le lien, pas de la soumission du formulaire !</span>
    <span class='k'>return</span> <span class='kc'>false</span><span class='p'>;</span>
<span class='p'>}).</span><span class='nx'>button</span><span class='p'>({</span><span class='nx'>label</span><span class='o'>:</span><span class='s1'>&#39;log in !&#39;</span><span class='p'>});</span>
</code></pre>
</div>
<h2 id='doiton_stopper_la_propagation_de_lvnement__'>Doit-on stopper la propagation de l&#8217;événement <tt>submit</tt> ?</h2>

<p>Le problème se pose si vous ne réalisez pas un &#8220;vrai&#8221; POST lorsque l&#8217;utilisateur déclenche la soumission du formulaire. Dans la majorité des applications riches, l&#8217;authentification se fait via une API, et donc un appel Ajax.</p>

<p>On se branche alors sur l&#8217;événement submit, et on annule sa propagation.</p>

<p>Seulement, en stoppant l&#8217;événement de soumission, le navigateur ne retient pas le login et le mot de passe.</p>

<blockquote>
<p><strong>Pour que le navigateur mémorise le couple login/mot de passe, l&#8217;événement <tt>submit</tt> doit se propager.</strong></p>
</blockquote>

<p>Cela implique:</p>

<ul>
<li>que le formulaire pointe sur une véritable url, sinon, une vilaine 404 apparaitra dans votre console</li>

<li>que le résultat de la soumission soit routée dans une iframe (désolé pour les puristes :)), sans quoi, toute la page se rechargera</li>
</ul>

<p>Donc généralement, mon service web propose une API POST qui ne fait rien et renvoie une page vide, et j&#8217;utilise une iframe masquée.</p>

<blockquote>
<p><strong>Edit</strong></p>
</blockquote>

<p>Les dernières versions de Chrome (15+) impose une nouvelle contrainte : il faut que le retour du serveur soit non vide. Donc votre &#8220;fausse API&#8221; POST doit renvoyer quelque chose (y compris une chaîne vide), mais en aucun cas un code HTTP 204 (OK BUT NO CONTENT)</p>

<p><strong>index.html</strong></p>
<div class='highlight'><pre><code class='html'><span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;loginStock&quot;</span> <span class='na'>style=</span><span class='s'>&quot;display:none&quot;</span> <span class='na'>method=</span><span class='s'>&quot;post&quot;</span> <span class='na'>action=</span><span class='s'>&quot;/api/login/noop&quot;</span> <span class='na'>target=</span><span class='s'>&quot;postFrame&quot;</span><span class='nt'>&gt;</span>
    <span class='nt'>&lt;form</span> <span class='na'>id=</span><span class='s'>&quot;formLogin&quot;</span><span class='nt'>&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>autofocus=</span><span class='s'>&quot;autofocus&quot;</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;username&quot;</span><span class='nt'>/&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>autocomplete=</span><span class='s'>&quot;on&quot;</span> <span class='na'>type=</span><span class='s'>&quot;password&quot;</span> <span class='na'>name=</span><span class='s'>&quot;password&quot;</span><span class='nt'>/&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;submit&quot;</span> <span class='na'>style=</span><span class='s'>&quot;display:none&quot;</span><span class='nt'>/&gt;</span>
    <span class='nt'>&lt;/form&gt;</span>
    <span class='nt'>&lt;a</span> <span class='na'>href=</span><span class='s'>&quot;#&quot;</span> <span class='na'>class=</span><span class='s'>&quot;submit&quot;</span><span class='nt'>&gt;&lt;/a&gt;</span>
<span class='nt'>&lt;/div&gt;</span>
<span class='nt'>&lt;iframe</span> <span class='na'>name=</span><span class='s'>&quot;postFrame&quot;</span> <span class='na'>class=</span><span class='s'>&quot;hidden&quot;</span><span class='nt'>&gt;&lt;/iframe&gt;</span>
</code></pre>
</div>
<p><strong>login.js</strong></p>
<div class='highlight'><pre><code class='js'><span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#formLogin&#39;</span><span class='p'>).</span><span class='nx'>submit</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>event</span><span class='p'>){</span>
    <span class='c1'>// Ici mon appel ajax, et surtout, ne pas renvoyer false ni invoquer event.stopPropagation().</span>
<span class='p'>});</span>
</code></pre>
</div>
<h3 id='une_petite_astuce__lorsque_lauthentification_choue'>Une petite astuce : lorsque l&#8217;authentification échoue.</h3>

<p>A partir du moment où l&#8217;événement <tt>submit</tt> est propagé, et qu&#8217;une réponse HTTP est reçue, le navigateur conservera bien le mot de passe et le login.</p>

<p>Mais nous pouvons tirer parti de ce comportement, lorsque l&#8217;authentification échoue, par exemple si l&#8217;utilisateur est inconnu, ou le mot de passe erroné.</p>

<p>Ainsi, mon appel Ajax est toujours <strong>synchrone</strong> (parfois ça sert !), et s&#8217;il échoue, alors dans ce cas, j&#8217;annule la propagation de l&#8217;événement <tt>submit</tt> pour ne pas conserver les mauvais identifiants.</p>

<h2 id='la_touche_entre_ne_soumet_pas_toujours_mon_formulaire'>La touche entrée ne soumet pas toujours mon formulaire&#8230;</h2>

<p>Hélas oui, c&#8217;est un comportement étrange de certains navigateurs : un formulaire sera automatiquement soumit si on appuie sur entrée dans un de ses champs, sauf si le bouton submit est invisible !</p>

<p>Donc il faut eviter le <tt>display:none</tt> ou le <tt>visibility:hidden</tt> sur le champ. Personnellement, je lui affecte une taille de zéro. Vous pouvez aussi le positionner en absolu, en dehors de la zone visible, ou le mettre en dessous d&#8217;un autre élément avec le <tt>z-index</tt></p>

<p><strong>index.html</strong></p>
<div class='highlight'><pre><code class='html'><span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;loginStock&quot;</span> <span class='na'>style=</span><span class='s'>&quot;display:none&quot;</span> <span class='na'>method=</span><span class='s'>&quot;post&quot;</span> <span class='na'>action=</span><span class='s'>&quot;/api/login/noop&quot;</span> <span class='na'>target=</span><span class='s'>&quot;postFrame&quot;</span><span class='nt'>&gt;</span>
    <span class='nt'>&lt;form</span> <span class='na'>id=</span><span class='s'>&quot;formLogin&quot;</span><span class='nt'>&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>autofocus=</span><span class='s'>&quot;autofocus&quot;</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;username&quot;</span><span class='nt'>/&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>autocomplete=</span><span class='s'>&quot;on&quot;</span> <span class='na'>type=</span><span class='s'>&quot;password&quot;</span> <span class='na'>name=</span><span class='s'>&quot;password&quot;</span><span class='nt'>/&gt;</span>
        <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;submit&quot;</span> <span class='na'>style=</span><span class='s'>&quot;width:0; height:0; border:0; padding:0&quot;</span><span class='nt'>/&gt;</span>
    <span class='nt'>&lt;/form&gt;</span>
    <span class='nt'>&lt;a</span> <span class='na'>href=</span><span class='s'>&quot;#&quot;</span> <span class='na'>class=</span><span class='s'>&quot;submit&quot;</span><span class='nt'>&gt;&lt;/a&gt;</span>
<span class='nt'>&lt;/div&gt;</span>
</code></pre>
</div>
<h2 id='conclusion'>Conclusion</h2>

<p>Vous voyez ? quand je vous disais que ce n&#8217;était pas trivial&#8230;</p>

<p>Mais maintenant, vous avez toutes les clefs pour faire des formulaires qui exploitent le cache de login/mot de passe des navigateurs.</p>

<p>Espérons que dans un futur proche, les navigateurs harmonisent un peu plus leur fonctionnement, de manière à éviter tout ces tricks&#8230;</p>

<p>Damien.</p>
  <footer>
    <section class="tags">
      <span>Tags :</span>
<ul>
  
    <li>
        <a href="tags.html#javascript" title="Voir les posts ayant le tag javascript">javascript</a>
    </li>
  
    <li>
        <a href="tags.html#login" title="Voir les posts ayant le tag login">login</a>
    </li>
  
    <li>
        <a href="tags.html#formulaire" title="Voir les posts ayant le tag formulaire">formulaire</a>
    </li>
  
    <li>
        <a href="tags.html#chrome" title="Voir les posts ayant le tag chrome">chrome</a>
    </li>
  
    <li>
        <a href="tags.html#firefox" title="Voir les posts ayant le tag firefox">firefox</a>
    </li>
  
    <li>
        <a href="tags.html#jQuery" title="Voir les posts ayant le tag jQuery">jQuery</a>
    </li>
  
</ul>

    </section>
    <section id="disqus_thread" class="comments">
      <script type="text/javascript">
  var disqus_shortname = 'pullrequest';
  var disqus_identifier = '/2011/10/19/subtilites-du-login';
  $.getScript("http://pullrequest.disqus.com/embed.js");
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus</a>.</noscript>

    </section>
  </footer>
</article>

      </section><!--

   --><aside>
        <section id="about">
          <h1>A propos</h1>
          <p>PullRequest est un blog de développeurs ouvert à toute contribution appropriée.</p>
        </section>
        <section id="follow">
          <h1>Suivez nous!</h1>
          <ul>
            <li>
              <a href="http://twitter.com/pullrequest" class="twitter-follow-button" data-show-count="false" data-lang="fr">Follow @pullrequest</a>
              <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
            </li>
            <li class="feed">
              <a rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/pullrequest/blog-posts">abonnement RSS</a>
            </li>
          </ul>
        </section>
        <section id="contribute">
          <h1>Participer</h1>
          <p>
            Les articles sont écrits en <a href="http://daringfireball.net/projects/markdown/syntax">MarkDown</a> et stockés dans un repository Git sur <a href="http://github.com/pullrequest/pullrequest.github.com">Github</a>.
            N'hésitez pas à <strong>forker</strong> puis à faire une <strong><a href="https://github.com/pullrequest/pullrequest.github.com/pull/new/master">Pull Request</a></strong> ;)
          </p>
        </section>
        <section id="licensing">
          <h1>Licence</h1>
          <p>
            Les articles sont mis à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by/2.0/fr/">Licence Creative Commons Paternité 2.0 France</a>.
            <a rel="license" href="http://creativecommons.org/licenses/by/2.0/fr/">
              <br><img alt="Contrat Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by/2.0/fr/88x31.png" />
            </a>
          </p>
        </section>
        <section id="opensource">
          <h1>OpenSource</h1>
          <p>Les auteurs de PullRequest sont à l'origine, ou contributeurs, entre autres, de ces projets:</p>
          <ul>
            <li><a href="http://openscales.org">OpenScales</a></li>
            <li><a href="http://resthub.org">RestHub</a></li>
            <li><a href="https://github.com/loicfrering/LosoBundle">LosoBundle</a></li>
            <li><a href="https://github.com/loicfrering/losolib">LoSoLib</a></li>
            <li><a href="https://bitbucket.org/feugy/myth">Myth</a></li>
          </ul>
        </section>
      </aside>

    </div>

    <footer>
      <small id="legal">© 2011 pullrequest.org</small>
      <small id="poweredby">Propulsé par <a href="http://jekyllrb.com">Jekyll</a></small>
    </footer>
  </div>

  <script defer src="/public/js/tags.js"></script>
  <script defer src="/public/js/authors.js"></script>

  <script>
    var _gaq=[["_setAccount","UA-22833612-1"],["_trackPageview"]];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
    g.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js";
    s.parentNode.insertBefore(g,s)}(document,"script"));
  </script>

  <!--[if lt IE 7 ]>
  <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
  <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

</body>
</html>
