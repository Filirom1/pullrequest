<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>.::PullRequest.org::. Web Socket - Are you plugged ?</title>
  <meta name="description" content="">
  <meta name="author" content="PullRequest team">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="/public/css/style.css">
  <link rel="stylesheet" href="/public/css/syntax.css">

  <script src="/public/js/libs/modernizr.custom.47336.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="/public/js/libs/jquery-1.6.2.min.js"><\/script>')</script>
</head>

<body>

  <div id="container">
    <header>
      <h1><a href="/" title="Page d'accueil"><img src="/public/img/pullrequest-logo.png" alt="PullRequest"/></a></h1>
      <a href="http://github.com/pullrequest"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 1;" src="https://a248.e.akamai.net/assets.github.com/img/abad93f42020b733148435e2cd92ce15c542d320/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub"></a>
    </header>

    <div id="main" role="main">
      <section id="content">
        
<article>
  <header>
    <h1><a href="/2011/04/19/web-socket-are-you-plugged.html">Web Socket - Are you plugged ?</a></h1>
    <p>
      <time datetime="2011-04-19" pubdate="pubdate">19 Apr 2011</time>
      <span class="author"><a href="/authors.html#feugy">Damien Feugas</a></span>
      <span class="comments"><a href="#disqus_thread" title="Voir les commentaires">Commentaires</a></span>
    </p>
  </header>
  <p>Depuis à peu près deux ans, je réalise un <a href='https://bitbucket.org/feugy/myth/wiki/Home'>MMORPG</a> gratuit et OpenSource avec un serveur Java et deux clients Flex (un d&#8217;administration et un de jeu).</p>

<p>J&#8217;ai utilisé le merveilleux framework <a href='http://www.graniteds.org/confluence/pages/viewpage.action?pageId=229378'>GraniteDS</a> qui est un pont entre le java et flex, comme BlazeDS d&#8217;Adobe, avec plus de fonctionnalités encore.</p>

<p>Malheureusement, j&#8217;ai surtout besoin de flexibilité coté client de jeu (tout le GameDesign est configurable via l&#8217;admin), et j&#8217;ai décidé finalement de tout réécrire en technologies Html 5/Css 3/Js.</p>

<p>Les 3 grandes fonctionnalités de GraniteDS qui doivent donc être remplacées sont les suivantes :</p>

<ol>
<li>L&#8217;invocation distante de méthodes Java, remplacée par une API REST. Chaque méthode du serveur est une url qui produit et consomme du XML ou du JSON. J&#8217;ai choisi <a href='http://jersey.java.net/'>Jersey</a> pour cela (implémentation de référence de la spécification JAX-RS).</li>

<li>Le MCV client &#8220;tide&#8221;, remplacé par <a href='https://bitbucket.org/ilabs/resthub-js/src'>RESTHub-js</a>.</li>

<li>Le push serveur : les clients flex sont constamment connectés au serveur qui leur envoi les mises à jour déclenchées par les autres joueurs. Ce billet explique comment j&#8217;ai remplacé cette partie par l&#8217;utilisation des WebSockets.</li>
</ol>

<h2 id='alors_comment_on_joue_'>Alors, comment on joue ?</h2>

<p>Les Web sockets sont juste&#8230; des sockets. C&#8217;est un canal connecté entre le navigateur et le serveur, ni plus, ni moins. Vous avez donc besoin d&#8217;un navigateur récent (Chrome, IE9 ou Firefox 4 correctement configuré) et d&#8217;un serveur.</p>

<p>Il y a quelques serveurs Java qui implémentent le protocole : jWebSocket, Kaazing, webbit&#8230; Mais aucun d&#8217;entre eux n&#8217;est aussi un conteneur de Servlet, la base de nos serveurs java. A l&#8217;exception de <a href='http://jetty.codehaus.org/jetty/'>Jetty</a>.</p>

<p>Sans rentrer dans les détails, Jetty est un serveur Http+Servlet+WebSocket très puissant écrit en java, qui peut être utilisé en mode embarqué ou standalone. Il implémente le brouillon de la norme Websocket depuis un petit moment, et <a href='http://blogs.webtide.com/gregw/entry/jetty_websocket_server'>plutôt simplement</a>.</p>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>WebSocketDummyServlet</span> <span class='kd'>extends</span> <span class='n'>WebSocketServlet</span> <span class='o'>{</span>

    <span class='cm'>/**</span>
<span class='cm'>     * Invoked by Jetty during the handshake: Return a WebSocket object to allow </span>
<span class='cm'>     * the connection establishement.</span>
<span class='cm'>     *</span>
<span class='cm'>     * &lt;em&gt;@param request&lt;/em&gt; Http upgrade request</span>
<span class='cm'>     * &lt;em&gt;@return&lt;/em&gt; The WebSocket Channel.</span>
<span class='cm'>     */</span>
    <span class='kd'>protected</span> <span class='n'>WebSocket</span> <span class='nf'>doWebSocketConnect</span><span class='o'>(</span><span class='n'>HttpServletRequest</span> <span class='n'>request</span><span class='o'>,</span> <span class='n'>String</span> <span class='n'>protocol</span><span class='o'>)</span> <span class='o'>{</span>
        <span class='k'>return</span> <span class='k'>new</span> <span class='nf'>DummyWebSocket</span><span class='o'>();</span>
    <span class='o'>}</span>

    <span class='cm'>/**</span>
<span class='cm'>     * Websocket channel dummy implementation.</span>
<span class='cm'>     */</span>
    <span class='kd'>implements</span> <span class='n'>WebSocket</span> <span class='o'>{</span>

        <span class='cm'>/**</span>
<span class='cm'>         * Object that sends message to the connected client with method </span>
<span class='cm'>         * sendMessage(String message).</span>
<span class='cm'>         *</span>
<span class='cm'>         */</span>
        <span class='n'>Outbound</span> <span class='n'>_outbound</span><span class='o'>;</span>

        <span class='cm'>/**</span>
<span class='cm'>         * Channel connexion.</span>
<span class='cm'>         */</span>
        <span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>onConnect</span><span class='o'>(</span><span class='n'>Outbound</span> <span class='n'>outbound</span><span class='o'>)</span> <span class='o'>{</span>
            <span class='n'>_outbound</span><span class='o'>=</span><span class='n'>outbound</span><span class='o'>;</span>
        <span class='o'>}</span>

        <span class='cm'>/**</span>
<span class='cm'>         * Invoked when the client sends a message.</span>
<span class='cm'>         * &lt;em&gt;@param&lt;/em&gt; &lt;em&gt;data &lt;/em&gt;The sent data</span>
<span class='cm'>         */</span>
        <span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>onMessage</span><span class='o'>(</span><span class='kt'>byte</span> <span class='n'>frame</span><span class='o'>,</span> <span class='n'>String</span> <span class='n'>data</span><span class='o'>){}</span>

        <span class='cm'>/**</span>
<span class='cm'>         * Channel disconnexion.</span>
<span class='cm'>         */</span>
        <span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>onDisconnect</span><span class='o'>(){}</span>
    <span class='o'>}</span>
<span class='o'>}</span>
</code></pre>
</div>
<p>Plutôt facile, non ? Cette servlet doit être déclarée dans le descripteur web.xml :</p>
<div class='highlight'><pre><code class='xml'><span class='nt'>&lt;servlet&gt;</span>
    <span class='nt'>&lt;/servlet-name&gt;</span>
    <span class='nt'>&lt;servlet-class&gt;</span>org.dummy.WebSocketDummyServlet<span class='nt'>&lt;/servlet-class&gt;</span>
    <span class='nt'>&lt;load-on-startup&gt;</span>1<span class='nt'>&lt;/load-on-startup&gt;</span>
<span class='nt'>&lt;/servlet&gt;</span>
<span class='nt'>&lt;servlet-mapping&gt;</span>
    <span class='nt'>&lt;servlet-name&gt;</span>wsServlet<span class='nt'>&lt;/servlet-name&gt;</span>
    <span class='nt'>&lt;url-pattern&gt;</span>/*<span class='nt'>&lt;/url-pattern&gt;</span>
<span class='nt'>&lt;/servlet-mapping&gt;</span>
</code></pre>
</div>
<p>Vous avez besoin d&#8217;envoyer des messages à tous les clients connectés ? Vous n&#8217;avez qu&#8217;à stocker les instances de DummyWebSocket créées, et ajouter une méthode qui utilisera _outbound.sendMessage().</p>

<h2 id='je_suis_connect__mais_je_peux_rien_faire'>Je suis connecté ! Mais je peux rien faire&#8230;</h2>

<p>Comme je le disais, vous n&#8217;avez qu&#8217;un tuyau connecté. Il transporte des chaînes de caractères et des bits. C&#8217;est efficace, mais pas vraiment utilisable en tant que tel.</p>

<p>Il est donc nécessaire d&#8217;implémenter un protocole au dessus de ce tuyau. Ce dernier dépendra de vos besoins. Une application de messagerie instantannée ? Utilisez XMPP. Une application de streaming ? Pourquoi pas RTP. Un jeu FPS ? créez votre propre protocole.<br />GraniteDS proposait un mécanisme de publication/souscription de POJO sérialisés, proche de JMS. Heureusement, il existe un équivalent parfait : <a href='http://stomp.codehaus.org/Protocol'>STOMP</a>.</p>

<p>Une minute ! Google donne quelques résultats pour &#8220;STOMP Websocket Java&#8221;. Notamment ActiveMQ, RabittMQ et HornetMQ, fameux brokers JMS. Utilisons-les. Enfin non : c&#8217;est vraiment de l&#8217;overkill : je n&#8217;avais pas besoin de toute cette mécanique complexe&#8230;</p>

<p>Alors j&#8217;ai implémenté le protocole STOMP (sans la gestion transactionnelle) et ça m&#8217;a pris deux jours. En fait, STOMP est vraiment très simple (tout est en texte, et les sauts de lignes sont significatifs) :</p>

<p><strong>client X, client Y :</strong></p>

<pre><code>CONNECT
login: X &lt;or&gt; Y
passcode: &lt;passcode&gt;

^@</code></pre>

<p><strong>client Y:</strong></p>

<pre><code>SUBSCRIBE
destination: /topic-1
ack: client

^@</code></pre>

<p><strong>client X:</strong></p>

<pre><code>SEND
destination: /topic-1

hello everyone !
^@</code></pre>

<p><strong>et le client Y reçoit:</strong></p>

<pre><code>MESSAGE
destination:/topic-1
message-id: &lt;message-identifier&gt;

hello everyone !
^@</code></pre>

<h2 id='et_cot_client_justement_'>Et coté client justement ?</h2>

<p>Le client en javascript est vraiment simple :</p>
<div class='highlight'><pre><code class='javascript'>    <span class='kd'>var</span> <span class='nx'>location</span> <span class='o'>=</span> <span class='nb'>document</span><span class='p'>.</span><span class='nx'>location</span><span class='p'>.</span><span class='nx'>toString</span><span class='p'>().</span><span class='nx'>replace</span><span class='p'>(</span><span class='s1'>&#39;http:&#39;</span><span class='p'>,</span><span class='s1'>&#39;ws:&#39;</span><span class='p'>);</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>_ws</span><span class='o'>=</span><span class='k'>new</span> <span class='nx'>WebSocket</span><span class='p'>(</span><span class='nx'>location</span><span class='p'>);</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>_ws</span><span class='p'>.</span><span class='nx'>onopen</span><span class='o'>=</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>_onopen</span><span class='p'>;</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>_ws</span><span class='p'>.</span><span class='nx'>onmessage</span><span class='o'>=</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>_onmessage</span><span class='p'>;</span>
    <span class='k'>this</span><span class='p'>.</span><span class='nx'>_ws</span><span class='p'>.</span><span class='nx'>onclose</span><span class='o'>=</span><span class='k'>this</span><span class='p'>.</span><span class='nx'>_onclose</span><span class='p'>;</span>

    <span class='nx'>_onopen</span><span class='o'>:</span> <span class='kd'>function</span><span class='p'>(){</span>
    <span class='p'>},</span>

    <span class='nx'>_send</span><span class='o'>:</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>message</span><span class='p'>){</span>
      <span class='k'>this</span><span class='p'>.</span><span class='nx'>_ws</span><span class='p'>.</span><span class='nx'>send</span><span class='p'>(</span><span class='nx'>message</span><span class='p'>);</span>
    <span class='p'>},</span>

    <span class='nx'>_onmessage</span><span class='o'>:</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>message</span><span class='p'>)</span> <span class='p'>{}</span>
</code></pre>
</div>
<p>Je n&#8217;ai pas encore choisi d&#8217;implémentation STOMP coté client et dès que je l&#8217;aurai fait, je mettrai cet article à jour.</p>

<p>Juste un avertissement : nous l&#8217;avons testé à travers des proxies, et ça fonctionne très bien.<br />Pas de déconnexion intempestives, pas de ralentissements.<br />Mais cela nécessite que le client envoie un keep-alive à travers le socket. Le serveur n&#8217;a pas besoin de répondre.</p>

<p>Un message de keep-alive toutes les 10 secondes marche bien, mais j&#8217;imagine que cela dépend des configurations des proxies et firewall traversés.</p>

<h2 id='jadore__o_est_le_code_'>J&#8217;adore ! Où est le code ?</h2>

<p>Actuellement, il est accessible sur bitbucket (licencié en LGPL-3):</p>

<ul>
<li><a href='https://bitbucket.org/feugy/myth/src/1a56ca416b5a/chronos-webapp/src/main/java/org/mythicforge/tools/websocket/'>Les objets Jetty</a> et leurs tests unitaires</li>

<li><a href='https://bitbucket.org/feugy/myth/src/1a56ca416b5a/chronos-webapp/src/main/java/org/mythicforge/tools/stomp/'>L&#8217;implémentation Stomp</a> et ses <a href='https://bitbucket.org/feugy/myth/src/1a56ca416b5a/chronos-webapp/src/test/java/org/mythicforge/tools/stomp/'>tests unitaires</a></li>

<li>Le client <a href='https://bitbucket.org/feugy/myth/src/1a56ca416b5a/chronos-webapp/src/test/java/org/mythicforge/tools/'>Java websocket</a> (classes WebSocketClient, IMessageReceiver, StompWebSocketListener)</li>
</ul>

<p>Vous l&#8217;avez deviné, je suis un fanatique du TDD. J&#8217;ai donc réalisé un client Websocket en Java. En effet mes tests unitaires lancent le serveur dans un Jetty en mémoire et agissent comme s&#8217;ils étaient des navigateurs.</p>

<p>Dès que je serai un peu plus disponible, je packagerai l&#8217;ensemble indépendamment de mon moteur de jeu, et je le reverserai à <a href='https://bitbucket.org/ilabs/resthub-js/'>RESThub-js</a>. En effet, il y a très peu de dépendances entre les deux, et je pense que cela peut être réutilisé dans d&#8217;autres contextes&#8230; Peut-être par vous :)</p>
  <footer>
    <section class="tags">
      <span>Tags :</span>
<ul>
  
    <li>
        <a href="tags.html#java" title="Voir les posts ayant le tag java">java</a>
    </li>
  
    <li>
        <a href="tags.html#javascript" title="Voir les posts ayant le tag javascript">javascript</a>
    </li>
  
    <li>
        <a href="tags.html#mythicforge" title="Voir les posts ayant le tag mythicforge">mythicforge</a>
    </li>
  
    <li>
        <a href="tags.html#graniteds" title="Voir les posts ayant le tag graniteds">graniteds</a>
    </li>
  
    <li>
        <a href="tags.html#jetty" title="Voir les posts ayant le tag jetty">jetty</a>
    </li>
  
    <li>
        <a href="tags.html#JMS" title="Voir les posts ayant le tag JMS">JMS</a>
    </li>
  
    <li>
        <a href="tags.html#STOMP" title="Voir les posts ayant le tag STOMP">STOMP</a>
    </li>
  
    <li>
        <a href="tags.html#websocket" title="Voir les posts ayant le tag websocket">websocket</a>
    </li>
  
</ul>

    </section>
    <section id="disqus_thread" class="comments">
      <script type="text/javascript">
  var disqus_shortname = 'pullrequest';
  var disqus_identifier = '/2011/04/19/web-socket-are-you-plugged';
  $.getScript("http://pullrequest.disqus.com/embed.js");
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus</a>.</noscript>

    </section>
  </footer>
</article>

      </section><!--

   --><aside>
        <section id="about">
          <h1>A propos</h1>
          <p>PullRequest est un blog de développeurs ouvert à toute contribution appropriée.</p>
        </section>
        <section id="follow">
          <h1>Suivez nous!</h1>
          <ul>
            <li>
              <a href="http://twitter.com/pullrequest" class="twitter-follow-button" data-show-count="false" data-lang="fr">Follow @pullrequest</a>
              <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
            </li>
            <li class="feed">
              <a rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/pullrequest/blog-posts">abonnement RSS</a>
            </li>
          </ul>
        </section>
        <section id="contribute">
          <h1>Participer</h1>
          <p>
            Les articles sont écrits en <a href="http://daringfireball.net/projects/markdown/syntax">MarkDown</a> et stockés dans un repository Git sur <a href="http://github.com/pullrequest/pullrequest.github.com">Github</a>.
            N'hésitez pas à <strong>forker</strong> puis à faire une <strong><a href="https://github.com/pullrequest/pullrequest.github.com/pull/new/master">Pull Request</a></strong> ;)
          </p>
        </section>
        <section id="licensing">
          <h1>Licence</h1>
          <p>
            Les articles sont mis à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by/2.0/fr/">Licence Creative Commons Paternité 2.0 France</a>.
            <a rel="license" href="http://creativecommons.org/licenses/by/2.0/fr/">
              <br><img alt="Contrat Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by/2.0/fr/88x31.png" />
            </a>
          </p>
        </section>
        <section id="opensource">
          <h1>OpenSource</h1>
          <p>Les auteurs de PullRequest sont à l'origine, ou contributeurs, entre autres, de ces projets:</p>
          <ul>
            <li><a href="http://openscales.org">OpenScales</a></li>
            <li><a href="http://resthub.org">RestHub</a></li>
            <li><a href="https://github.com/loicfrering/LosoBundle">LosoBundle</a></li>
            <li><a href="https://github.com/loicfrering/losolib">LoSoLib</a></li>
            <li><a href="https://bitbucket.org/feugy/myth">Myth</a></li>
          </ul>
        </section>
      </aside>

    </div>

    <footer>
      <small id="legal">© 2011 pullrequest.org</small>
      <small id="poweredby">Propulsé par <a href="http://jekyllrb.com">Jekyll</a></small>
    </footer>
  </div>

  <script defer src="/public/js/tags.js"></script>
  <script defer src="/public/js/authors.js"></script>

  <script>
    var _gaq=[["_setAccount","UA-22833612-1"],["_trackPageview"]];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
    g.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js";
    s.parentNode.insertBefore(g,s)}(document,"script"));
  </script>

  <!--[if lt IE 7 ]>
  <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
  <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

</body>
</html>
