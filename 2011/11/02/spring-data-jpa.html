<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>.::PullRequest.org::. Spring Data JPA</title>
  <meta name="description" content="">
  <meta name="author" content="PullRequest team">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="/public/css/style.css">
  <link rel="stylesheet" href="/public/css/syntax.css">

  <script src="/public/js/libs/modernizr.custom.47336.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="/public/js/libs/jquery-1.6.2.min.js"><\/script>')</script>
</head>

<body>

  <div id="container">
    <header>
      <h1><a href="/" title="Page d'accueil"><img src="/public/img/pullrequest-logo.png" alt="PullRequest"/></a></h1>
      <a href="http://github.com/pullrequest"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 1;" src="https://a248.e.akamai.net/assets.github.com/img/abad93f42020b733148435e2cd92ce15c542d320/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub"></a>
    </header>

    <div id="main" role="main">
      <section id="content">
        
<article>
  <header>
    <h1><a href="/2011/11/02/spring-data-jpa.html">Spring Data JPA</a></h1>
    <p>
      <time datetime="2011-11-02" pubdate="pubdate">02 Nov 2011</time>
      <span class="author"><a href="/authors.html#jvillanti">Julien Villanti</a></span>
      <span class="comments"><a href="#disqus_thread" title="Voir les commentaires">Commentaires</a></span>
    </p>
  </header>
  <p>La préparation <a href='http://pullrequest.org/2011/09/07/resthub-2-preview.html'>de la version 2 de RESThub</a> et l’objectif de remplacer <a href='http://redmine.synyx.org/'>Hades</a> par <a href='http://www.springsource.org/spring-data'>Spring-data</a> nous a amené à étudier le module spring-data-jpa et ses capacités.</p>

<h2 id='prsentation'>Présentation</h2>

<p>Le projet <a href='http://www.springsource.org/spring-data'>Spring-data</a> est un projet visant à simplifier l’utilisation des bases relationnelles et des bases NoSQL (Graph, Key-Value, Document). En plus des facilités de manipulation de données offertes par le projet, Spring Data supporte le framework <a href='http://www.querydsl.com/'>QueryDsl</a> et ainsi la possibilité de donner <a href='http://en.wikipedia.org/wiki/Domain-driven_design'>une orientation DDD</a>. Sans rentrer dans les détails, on assiste peut être à la fin de nos modèles métiers anémiques !</p>

<h2 id='cas_dutilisation_basique'>Cas d’utilisation basique</h2>

<p>Maintenant on rentre dans le vif du sujet avec un projet exemple montrant les possibilités offertes par Spring Data JPA.</p>

<h3 id='1_objet_domain'>1) Objet domain</h3>
<div class='highlight'><pre><code class='java'><span class='c1'>// User entity</span>
<span class='nd'>@Entity</span>
<span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>User</span> <span class='o'>{</span>
    <span class='nd'>@Id</span>
    <span class='nd'>@GeneratedValue</span><span class='o'>(</span><span class='n'>strategy</span> <span class='o'>=</span> <span class='n'>GenerationType</span><span class='o'>.</span><span class='na'>AUTO</span><span class='o'>)</span>
    <span class='kd'>private</span> <span class='n'>Long</span> <span class='n'>id</span><span class='o'>;</span>

    <span class='nd'>@Column</span><span class='o'>(</span><span class='n'>unique</span> <span class='o'>=</span> <span class='kc'>true</span><span class='o'>,</span> <span class='n'>nullable</span> <span class='o'>=</span> <span class='kc'>false</span><span class='o'>)</span>
    <span class='kd'>private</span> <span class='n'>String</span> <span class='n'>username</span><span class='o'>;</span>

    <span class='nd'>@Column</span><span class='o'>(</span><span class='n'>nullable</span> <span class='o'>=</span> <span class='kc'>false</span><span class='o'>)</span>
    <span class='kd'>private</span> <span class='n'>Integer</span> <span class='n'>age</span><span class='o'>;</span>

    <span class='c1'>// Getters et Setters</span>
<span class='o'>}</span>
</code></pre>
</div>
<p>Ici, Pojo classique pour ne pas dire &#8220;anémique&#8221;. Aucune référence à spring-data n&#8217;est nécessaire.</p>

<h3 id='2_repository'>2) Repository</h3>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>interface</span> <span class='nc'>UserRepository</span> <span class='kd'>extends</span> <span class='n'>JpaRepository</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>,</span> <span class='n'>Long</span><span class='o'>&gt;</span> <span class='o'>{</span>
    <span class='n'>User</span> <span class='nf'>findByUsername</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>username</span><span class='o'>);</span>

    <span class='n'>List</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>findByUsernameAndAge</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>username</span><span class='o'>,</span> <span class='n'>Integer</span> <span class='n'>age</span><span class='o'>);</span>

    <span class='n'>Page</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>findByUsernameLike</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>username</span><span class='o'>,</span> <span class='n'>Pageable</span> <span class='n'>pageable</span><span class='o'>);</span>

    <span class='nd'>@Query</span><span class='o'>(</span><span class='s'>&quot;SELECT u FROM User u WHERE u.username like ?1&quot;</span><span class='o'>)</span>
    <span class='n'>Page</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>findByUsernameLikeCusom</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>username</span><span class='o'>,</span> <span class='n'>Pageable</span> <span class='n'>pageable</span><span class='o'>);</span>

    <span class='n'>List</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>findByAgeBetween</span><span class='o'>(</span><span class='n'>Integer</span> <span class='n'>min</span><span class='o'>,</span> <span class='n'>Integer</span> <span class='n'>max</span><span class='o'>);</span>
<span class='o'>}</span>
</code></pre>
</div>
<p>Le travail au niveau du repository se limite à l&#8217;écriture de l&#8217;interface et c&#8217;est spring-data-jpa qui se charge de faire l&#8217;implémentation. Les habitués du framework <a href='http://redmine.synyx.org/'>Hades</a> reconnaitront sans mal ce mode de fonctionnement. Pour les autres, plusieurs mises en oeuvre sont disponibles :</p>

<ul>
<li>le framework compose automatiquement les requêtes en se basant sur des mots clés (byXXX, Order, …) (ex : findByUsernameAndAge, &#8230;) <a href='http://static.springsource.org/spring-data/data-jpa/docs/1.0.0.RC1/reference/html/#repositories.query-methods.property-expressions'>liste de mots clés</a>.</li>

<li>l’utilisateur écrit directement la requête (utilisation de @Query) avec la posibilité d&#8217;utiliser des paramètres nommés.</li>
</ul>

<p>A savoir, qu’il est possible de gérer la pagination pour les requêtes qui peuvent ramener beaucoup de résultats.</p>

<h3 id='3_configuration_spring'>3) Configuration Spring</h3>

<p>Il faut juste indiquer à spring-data-jpa le package où se trouvent vos repositories qu&#8217;il doit gérer :</p>
<div class='highlight'><pre><code class='xml'><span class='nt'>&lt;jpa:repositories</span> <span class='na'>base-package=</span><span class='s'>&quot;fr.test.repository&quot;</span> <span class='nt'>/&gt;</span>
</code></pre>
</div>
<h3 id='4_tests'>4) Tests</h3>

<p>Maintenant on passe aux tests unitaires de notre &#8220;userRepository&#8221;</p>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>UserRepositoryTest</span> <span class='o'>{</span>
    <span class='nd'>@Autowired</span>
    <span class='kd'>private</span> <span class='n'>UserRepository</span> <span class='n'>userRepositoryImpl</span><span class='o'>;</span>

    <span class='kd'>private</span> <span class='n'>User</span> <span class='n'>userTest1</span> <span class='o'>=</span> <span class='n'>newUser</span><span class='o'>(</span><span class='s'>&quot;Test1&quot;</span><span class='o'>,</span> <span class='mi'>16</span><span class='o'>);</span>
    <span class='kd'>private</span> <span class='n'>User</span> <span class='n'>userTest2</span> <span class='o'>=</span> <span class='n'>newUser</span><span class='o'>(</span><span class='s'>&quot;Test2&quot;</span><span class='o'>,</span> <span class='mi'>18</span><span class='o'>);</span>
    <span class='kd'>private</span> <span class='n'>User</span> <span class='n'>userTest3</span> <span class='o'>=</span> <span class='n'>newUser</span><span class='o'>(</span><span class='s'>&quot;Toto&quot;</span><span class='o'>,</span> <span class='mi'>21</span><span class='o'>);</span>
    <span class='kd'>private</span> <span class='n'>List</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>usersTest</span> <span class='o'>=</span> <span class='k'>new</span> <span class='n'>ArrayList</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;(</span><span class='n'>Arrays</span><span class='o'>.</span><span class='na'>asList</span><span class='o'>(</span><span class='n'>userTest1</span><span class='o'>,</span> <span class='n'>userTest2</span><span class='o'>,</span> <span class='n'>userTest3</span><span class='o'>));</span>

    <span class='nd'>@Test</span>
    <span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>testSave</span><span class='o'>()</span> <span class='o'>{</span>
        <span class='n'>userRepositoryImpl</span><span class='o'>.</span><span class='na'>save</span><span class='o'>(</span><span class='n'>userTest1</span><span class='o'>);</span>
        <span class='n'>assertNotNull</span><span class='o'>(</span><span class='n'>userRepositoryImpl</span><span class='o'>.</span><span class='na'>findOne</span><span class='o'>(</span><span class='n'>userTest1</span><span class='o'>.</span><span class='na'>getId</span><span class='o'>()));</span>
    <span class='o'>}</span>

    <span class='nd'>@Test</span>
    <span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>testFindOne</span><span class='o'>()</span> <span class='o'>{</span>
        <span class='n'>User</span> <span class='n'>user</span> <span class='o'>=</span> <span class='n'>userRepositoryImpl</span><span class='o'>.</span><span class='na'>save</span><span class='o'>(</span><span class='n'>userTest1</span><span class='o'>);</span>
        <span class='n'>assertNotNull</span><span class='o'>(</span><span class='n'>userRepositoryImpl</span><span class='o'>.</span><span class='na'>findOne</span><span class='o'>(</span><span class='n'>userTest1</span><span class='o'>.</span><span class='na'>getId</span><span class='o'>()));</span>

        <span class='n'>user</span> <span class='o'>=</span> <span class='n'>userRepositoryImpl</span><span class='o'>.</span><span class='na'>findOne</span><span class='o'>(</span><span class='n'>userTest1</span><span class='o'>.</span><span class='na'>getId</span><span class='o'>());</span>
        <span class='n'>assertNotNull</span><span class='o'>(</span><span class='n'>user</span><span class='o'>);</span>
        <span class='n'>assertEquals</span><span class='o'>(</span><span class='n'>user</span><span class='o'>.</span><span class='na'>getId</span><span class='o'>(),</span> <span class='n'>userTest1</span><span class='o'>.</span><span class='na'>getId</span><span class='o'>());</span>
    <span class='o'>}</span>
    <span class='c1'>//ETC ...</span>
<span class='o'>}</span>
</code></pre>
</div>
<p>Rien de spécial, on injecte notre repository et on peut ensuite tester toutes les méthodes.</p>

<h2 id='1er_bilan_'>1er bilan :</h2>

<ul>
<li>
<p>Avantages :</p>

<ul>
<li>pour ceux qui connaissent Hades, on est très proche du mode de fonctionnement;</li>

<li>les fonctions CRUD déjà implémentées;</li>

<li>le mode implémentation automatique permet de gagner du temps dans les petits développements.</li>
</ul>
</li>

<li>
<p>Inconvénients :</p>

<ul>
<li>les interfaces peuvent vite devenir confuses avec des FindByXXXAndYYY, FindByXXXAndYYYOrderBy, &#8230;</li>
</ul>
</li>
</ul>

<h2 id='cas_dutilisation_avanc'>Cas d’utilisation avancé</h2>

<h3 id='1_ajouter_des_mthodes_spcifiques_au_repository'>1) Ajouter des méthodes spécifiques au repository</h3>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>interface</span> <span class='nc'>UserRepositoryCustom</span> <span class='o'>{</span>
    <span class='kd'>public</span> <span class='kt'>boolean</span> <span class='nf'>customMethod</span><span class='o'>(</span><span class='n'>User</span> <span class='n'>user</span><span class='o'>);</span>
<span class='o'>}</span>

<span class='nd'>@Repository</span><span class='o'>(</span><span class='s'>&quot;userRepositoryImpl&quot;</span><span class='o'>)</span>
<span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>UserRepositoryCustomImpl</span> <span class='kd'>implements</span> <span class='n'>UserRepositoryCustom</span> <span class='o'>{</span>
    <span class='kd'>private</span> <span class='kd'>static</span> <span class='kd'>final</span> <span class='n'>Logger</span> <span class='n'>LOGGER</span> <span class='o'>=</span> <span class='n'>LoggerFactory</span><span class='o'>.</span><span class='na'>getLogger</span><span class='o'>(</span><span class='n'>UserRepositoryCustom</span><span class='o'>.</span><span class='na'>class</span><span class='o'>);</span>

    <span class='kd'>public</span> <span class='kt'>boolean</span> <span class='nf'>customMethod</span><span class='o'>(</span><span class='n'>User</span> <span class='n'>user</span><span class='o'>)</span> <span class='o'>{</span>
        <span class='n'>LOGGER</span><span class='o'>.</span><span class='na'>info</span><span class='o'>(</span><span class='s'>&quot;Methode ajoutee au repository : UserRepository&quot;</span><span class='o'>);</span>
        <span class='k'>return</span> <span class='kc'>true</span><span class='o'>;</span>
    <span class='o'>}</span>
<span class='o'>}</span>

<span class='nd'>@Repository</span><span class='o'>(</span><span class='s'>&quot;userRepositoryImpl&quot;</span><span class='o'>)</span>
<span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>UserRepositoryCustomImpl</span> <span class='kd'>implements</span> <span class='n'>UserRepositoryCustom</span> <span class='o'>{</span>
    <span class='kd'>private</span> <span class='kd'>static</span> <span class='kd'>final</span> <span class='n'>Logger</span> <span class='n'>LOGGER</span> <span class='o'>=</span> <span class='n'>LoggerFactory</span><span class='o'>.</span><span class='na'>getLogger</span><span class='o'>(</span><span class='n'>UserRepositoryCustom</span><span class='o'>.</span><span class='na'>class</span><span class='o'>);</span>

    <span class='kd'>public</span> <span class='kt'>boolean</span> <span class='nf'>customMethod</span><span class='o'>(</span><span class='n'>User</span> <span class='n'>user</span><span class='o'>){</span>
        <span class='n'>LOGGER</span><span class='o'>.</span><span class='na'>info</span><span class='o'>(</span><span class='s'>&quot;Methode ajoutee au repository : UserRepository&quot;</span><span class='o'>);</span>
        <span class='k'>return</span> <span class='kc'>true</span><span class='o'>;</span>
    <span class='o'>}</span>
<span class='o'>}</span>
</code></pre>
</div>
<p>Que du classique : A savoir la déclaration et l&#8217;implémentation des méthodes que l&#8217;on souhaite ajouter à notre repository. Il s&#8217;agit d&#8217;un bean classique que l&#8217;on pourrait injecter dans une classe indépendamment de notre repository.</p>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>interface</span> <span class='nc'>UserRepository</span> <span class='kd'>extends</span> <span class='n'>JpaRepository</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>,</span> <span class='n'>Long</span><span class='o'>&gt;,</span> <span class='n'>UserRepositoryCustom</span><span class='o'>{</span>
    <span class='n'>User</span> <span class='nf'>findByUsername</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>username</span><span class='o'>);</span>

    <span class='n'>List</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>findByUsernameAndAge</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>username</span><span class='o'>,</span> <span class='n'>Integer</span> <span class='n'>age</span><span class='o'>);</span>

    <span class='n'>Page</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>findByUsernameLike</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>username</span><span class='o'>,</span> <span class='n'>Pageable</span> <span class='n'>pageable</span><span class='o'>);</span>

    <span class='nd'>@Query</span><span class='o'>(</span><span class='s'>&quot;SELECT u FROM User u WHERE u.username like ?1&quot;</span><span class='o'>)</span>
    <span class='n'>Page</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>findByUsernameLikeCusom</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>username</span><span class='o'>,</span> <span class='n'>Pageable</span> <span class='n'>pageable</span><span class='o'>);</span>

    <span class='n'>List</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>findByAgeBetween</span><span class='o'>(</span><span class='n'>Integer</span> <span class='n'>min</span><span class='o'>,</span> <span class='n'>Integer</span> <span class='n'>max</span><span class='o'>);</span>
<span class='o'>}</span>
</code></pre>
</div>
<p>On rajoute à notre repository &#8220;UserRepository&#8221; un extends sur notre repository UserRepositoryCustom et hop on profite des fonctionnalités de spring-data-jpa en plus de celles de notre implémentation spécifique.</p>

<p>A savoir qu&#8217;il est possible d&#8217;ajouter des comportements &#8220;par défaut&#8221; à tous les repositories. <a href='http://static.springsource.org/spring-data/data-jpa/docs/current/reference/html/#repositories.custom-behaviour-for-all-repositories'>(cf la doc de spring-data)</a>.</p>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>UserRepositoryTest</span> <span class='o'>{</span>
    <span class='c1'>//...</span>

    <span class='nd'>@Autowired</span>
    <span class='kd'>private</span> <span class='n'>UserRepository</span> <span class='n'>userRepositoryImpl</span><span class='o'>;</span>

    <span class='nd'>@Test</span>
    <span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>testCustomMethod</span><span class='o'>()</span> <span class='o'>{</span>
        <span class='kt'>boolean</span> <span class='n'>result</span> <span class='o'>=</span> <span class='n'>userRepositoryImpl</span><span class='o'>.</span><span class='na'>customMethod</span><span class='o'>(</span><span class='n'>userTest1</span><span class='o'>);</span>
        <span class='n'>assertTrue</span><span class='o'>(</span><span class='n'>result</span><span class='o'>);</span>
    <span class='o'>}</span>
    <span class='c1'>//.....</span>
<span class='o'>}</span>
</code></pre>
</div>
<p>Rien de particulier, on teste que notre UserRepository profite bien de la fonction définie dans notre UserRepositoryCustom.</p>

<h3 id='2_utilisation_de_querydsl'>2) Utilisation de queryDsl</h3>

<p>QueryDsl est un framework qui permet d&#8217;écrire des requêtes type-safe via un <a href='http://en.wikipedia.org/wiki/Domain-specific_language'>Domain Specific Language</a> proposant une API fluide (fluent API). Grâce à QueryDsl on va pouvoir supprimer une des limites énoncées dans le 1er bilan et éviter pas mal de surprises à l&#8217;exécution. On va même discrètement rajouter un peu de métier dans un autre objet du domain.</p>

<h4 id='1re_tape__gnration_des_classes_q'>1ère étape : Génération des classes Q*</h4>

<p>Afin de pouvoir utiliser les classes QXXX (ici QUser) il faut les générer. Il existe un plugin Maven dédié à ce travail.</p>
<div class='highlight'><pre><code class='xml'>    <span class='nt'>&lt;plugin&gt;</span>
        <span class='nt'>&lt;groupId&gt;</span>com.mysema.maven<span class='nt'>&lt;/groupId&gt;</span>
        <span class='nt'>&lt;artifactId&gt;</span>maven-apt-plugin<span class='nt'>&lt;/artifactId&gt;</span>
        <span class='nt'>&lt;version&gt;</span>1.0.2<span class='nt'>&lt;/version&gt;</span>
        <span class='nt'>&lt;executions&gt;</span>
            <span class='nt'>&lt;execution&gt;</span>
                <span class='nt'>&lt;phase&gt;</span>generate-sources<span class='nt'>&lt;/phase&gt;</span>
                <span class='nt'>&lt;goals&gt;</span>
                    <span class='nt'>&lt;goal&gt;</span>process<span class='nt'>&lt;/goal&gt;</span>
                <span class='nt'>&lt;/goals&gt;</span>
                <span class='nt'>&lt;configuration&gt;</span>
                    <span class='nt'>&lt;outputDirectory&gt;</span>target/generated-sources<span class='nt'>&lt;/outputDirectory&gt;</span>
                    <span class='nt'>&lt;processor&gt;</span>com.mysema.query.apt.jpa.JPAAnnotationProcessor<span class='nt'>&lt;/processor&gt;</span>
                <span class='nt'>&lt;/configuration&gt;</span>
            <span class='nt'>&lt;/execution&gt;</span>
        <span class='nt'>&lt;/executions&gt;</span>
    <span class='nt'>&lt;/plugin&gt;</span>
</code></pre>
</div>
<p>Rem : Pour les utilisateurs d&#8217;Eclipse il faut penser à faire un &#8220;update project configuaration&#8221;.</p>

<h4 id='2me_tape__utilisation_de_querydsl_dans_les_repositories'>2ème étape : Utilisation de QueryDsl dans les repositories</h4>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>interface</span> <span class='nc'>UserRepository</span> <span class='kd'>extends</span> <span class='n'>JpaRepository</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>,</span> <span class='n'>Long</span><span class='o'>&gt;,</span> <span class='n'>UserRepositoryCustom</span><span class='o'>,</span> <span class='n'>QueryDslPredicateExecutor</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;{</span>
    <span class='n'>User</span> <span class='nf'>findByUsername</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>username</span><span class='o'>);</span>

    <span class='n'>List</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>findByUsernameAndAge</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>username</span><span class='o'>,</span> <span class='n'>Integer</span> <span class='n'>age</span><span class='o'>);</span>

    <span class='n'>Page</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>findByUsernameLike</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>username</span><span class='o'>,</span> <span class='n'>Pageable</span> <span class='n'>pageable</span><span class='o'>);</span>

    <span class='nd'>@Query</span><span class='o'>(</span><span class='s'>&quot;SELECT u FROM User u WHERE u.username like ?1&quot;</span><span class='o'>)</span>
    <span class='n'>Page</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>findByUsernameLikeCusom</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>username</span><span class='o'>,</span> <span class='n'>Pageable</span> <span class='n'>pageable</span><span class='o'>);</span>

    <span class='n'>List</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>findByAgeBetween</span><span class='o'>(</span><span class='n'>Integer</span> <span class='n'>min</span><span class='o'>,</span> <span class='n'>Integer</span> <span class='n'>max</span><span class='o'>);</span>
<span class='o'>}</span>
</code></pre>
</div>
<h4 id='3me_tape__on_teste'>3ème étape : On teste</h4>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>UserRepositoryTest</span> <span class='o'>{</span>
    <span class='c1'>//...</span>

    <span class='nd'>@Test</span>
    <span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>testQueryDsl</span><span class='o'>()</span> <span class='o'>{</span>
        <span class='n'>List</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>users</span> <span class='o'>=</span> <span class='n'>userRepositoryImpl</span><span class='o'>.</span><span class='na'>save</span><span class='o'>(</span><span class='n'>usersTest</span><span class='o'>);</span>
        <span class='n'>users</span> <span class='o'>=</span> <span class='n'>userRepositoryImpl</span><span class='o'>.</span><span class='na'>findAll</span><span class='o'>();</span>
        <span class='n'>assertNotNull</span><span class='o'>(</span><span class='n'>users</span><span class='o'>);</span>
        <span class='n'>assertTrue</span><span class='o'>(</span><span class='n'>users</span><span class='o'>.</span><span class='na'>size</span><span class='o'>()</span> <span class='o'>==</span> <span class='mi'>3</span><span class='o'>);</span>

        <span class='n'>users</span> <span class='o'>=</span> <span class='o'>(</span><span class='n'>List</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;)</span> <span class='n'>userRepositoryImpl</span><span class='o'>.</span><span class='na'>findAll</span><span class='o'>(</span><span class='n'>QUser</span><span class='o'>.</span><span class='na'>user</span><span class='o'>.</span><span class='na'>username</span><span class='o'>.</span><span class='na'>like</span><span class='o'>(</span><span class='s'>&quot;Test%&quot;</span><span class='o'>).</span><span class='na'>and</span>                                                                              <span class='o'>(</span><span class='n'>QUser</span><span class='o'>.</span><span class='na'>user</span><span class='o'>.</span><span class='na'>age</span><span class='o'>.</span><span class='na'>eq</span><span class='o'>(</span><span class='n'>userTest1</span><span class='o'>.</span><span class='na'>getAge</span><span class='o'>())));</span>
        <span class='n'>assertNotNull</span><span class='o'>(</span><span class='n'>users</span><span class='o'>);</span>
        <span class='n'>assertTrue</span><span class='o'>(</span><span class='n'>users</span><span class='o'>.</span><span class='na'>size</span><span class='o'>()</span> <span class='o'>==</span> <span class='mi'>1</span><span class='o'>);</span>
        <span class='n'>assertTrue</span><span class='o'>(</span><span class='n'>users</span><span class='o'>.</span><span class='na'>get</span><span class='o'>(</span><span class='mi'>0</span><span class='o'>).</span><span class='na'>getId</span><span class='o'>()</span> <span class='o'>==</span> <span class='n'>userTest1</span><span class='o'>.</span><span class='na'>getId</span><span class='o'>());</span>
        <span class='n'>assertTrue</span><span class='o'>(</span><span class='n'>users</span><span class='o'>.</span><span class='na'>size</span><span class='o'>()</span> <span class='o'>==</span> <span class='mi'>1</span><span class='o'>);</span> <span class='n'>assertTrue</span><span class='o'>(</span><span class='n'>users</span><span class='o'>.</span><span class='na'>get</span><span class='o'>(</span><span class='mi'>0</span><span class='o'>).</span><span class='na'>getAge</span><span class='o'>()</span> <span class='o'>&lt;</span> <span class='mi'>18</span><span class='o'>);</span>
    <span class='o'>}</span>
    <span class='c1'>//....</span>
<span class='o'>}</span>
</code></pre>
</div>
<p>Et hop, on peut profiter de tout un langage (DSL) pour générer ses requêtes type-safe! <a href='http://source.mysema.com/static/querydsl/2.2.0/reference/html'>voir la documentation de QueryDsl</a>. La complétion rajoute vraiment un confort non négligeable.</p>

<h4 id='4me_tape__cration_des_predicats'>4ème étape : Création des predicats</h4>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>UserPredicates</span> <span class='o'>{</span>

    <span class='kd'>public</span> <span class='kd'>static</span> <span class='n'>BooleanExpression</span> <span class='nf'>isMinor</span><span class='o'>()</span> <span class='o'>{</span>
        <span class='k'>return</span> <span class='n'>QUser</span><span class='o'>.</span><span class='na'>user</span><span class='o'>.</span><span class='na'>age</span><span class='o'>.</span><span class='na'>lt</span><span class='o'>(</span><span class='mi'>18</span><span class='o'>);</span>
    <span class='o'>}</span>
<span class='o'>}</span>
</code></pre>
</div>
<h4 id='5me_tape__on_teste_les_prdicats'>5ème étape : On teste les prédicats</h4>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>UserRepositoryTest</span> <span class='o'>{</span>
    <span class='c1'>//...</span>
    <span class='nd'>@Test</span>
    <span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>testQueryDsl2</span><span class='o'>()</span> <span class='o'>{</span>
        <span class='n'>List</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;</span> <span class='n'>users</span> <span class='o'>=</span> <span class='n'>userRepositoryImpl</span><span class='o'>.</span><span class='na'>save</span><span class='o'>(</span><span class='n'>usersTest</span><span class='o'>);</span>
        <span class='n'>users</span> <span class='o'>=</span> <span class='n'>userRepositoryImpl</span><span class='o'>.</span><span class='na'>findAll</span><span class='o'>();</span>
        <span class='n'>assertNotNull</span><span class='o'>(</span><span class='n'>users</span><span class='o'>);</span>
        <span class='n'>assertTrue</span><span class='o'>(</span><span class='n'>users</span><span class='o'>.</span><span class='na'>size</span><span class='o'>()</span> <span class='o'>==</span> <span class='mi'>3</span><span class='o'>);</span>

        <span class='n'>users</span> <span class='o'>=</span> <span class='o'>(</span><span class='n'>List</span><span class='o'>&lt;</span><span class='n'>User</span><span class='o'>&gt;)</span> <span class='n'>userRepositoryImpl</span><span class='o'>.</span><span class='na'>findAll</span><span class='o'>(</span><span class='n'>QUser</span><span class='o'>.</span><span class='na'>user</span><span class='o'>.</span><span class='na'>username</span><span class='o'>.</span><span class='na'>like</span><span class='o'>(</span><span class='s'>&quot;T%&quot;</span><span class='o'>).</span><span class='na'>and</span><span class='o'>(</span><span class='n'>UserPredicates</span><span class='o'>.</span><span class='na'>isMinor</span><span class='o'>()));</span>
        <span class='n'>assertNotNull</span><span class='o'>(</span><span class='n'>users</span><span class='o'>);</span>
        <span class='n'>assertTrue</span><span class='o'>(</span><span class='n'>users</span><span class='o'>.</span><span class='na'>size</span><span class='o'>()</span> <span class='o'>==</span> <span class='mi'>1</span><span class='o'>);</span>
        <span class='n'>assertTrue</span><span class='o'>(</span><span class='n'>users</span><span class='o'>.</span><span class='na'>get</span><span class='o'>(</span><span class='mi'>0</span><span class='o'>).</span><span class='na'>getAge</span><span class='o'>()</span> <span class='o'>&lt;</span> <span class='mi'>18</span><span class='o'>);</span>
    <span class='o'>}</span>
    <span class='c1'>//...</span>
<span class='o'>}</span>
</code></pre>
</div>
<p>On peut maintenant utiliser les prédicats prédéfinis pour générer des requêtes.</p>

<h2 id='2me_bilan_'>2ème bilan :</h2>

<ul>
<li>On retrouve bien les concepts d&#8217;Hades et la possibilité d&#8217;étendre les repositories afin de rajouter des méthodes spécifiques.</li>

<li>L&#8217;utilisation du QueryDsl est vraiment intéressante. On peut fabriquer des requêtes type-safe et dans un langue proche du langage courant et on profite de la complétion !</li>
</ul>
  <footer>
    <section class="tags">
      <span>Tags :</span>
<ul>
  
    <li>
        <a href="tags.html#resthub" title="Voir les posts ayant le tag resthub">resthub</a>
    </li>
  
    <li>
        <a href="tags.html#spring-data" title="Voir les posts ayant le tag spring-data">spring-data</a>
    </li>
  
    <li>
        <a href="tags.html#QueryDsl" title="Voir les posts ayant le tag QueryDsl">QueryDsl</a>
    </li>
  
</ul>

    </section>
    <section id="disqus_thread" class="comments">
      <script type="text/javascript">
  var disqus_shortname = 'pullrequest';
  var disqus_identifier = '/2011/11/02/spring-data-jpa';
  $.getScript("http://pullrequest.disqus.com/embed.js");
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus</a>.</noscript>

    </section>
  </footer>
</article>

      </section><!--

   --><aside>
        <section id="about">
          <h1>A propos</h1>
          <p>PullRequest est un blog de développeurs ouvert à toute contribution appropriée.</p>
        </section>
        <section id="follow">
          <h1>Suivez nous!</h1>
          <ul>
            <li>
              <a href="http://twitter.com/pullrequest" class="twitter-follow-button" data-show-count="false" data-lang="fr">Follow @pullrequest</a>
              <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
            </li>
            <li class="feed">
              <a rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/pullrequest/blog-posts">abonnement RSS</a>
            </li>
          </ul>
        </section>
        <section id="contribute">
          <h1>Participer</h1>
          <p>
            Les articles sont écrits en <a href="http://daringfireball.net/projects/markdown/syntax">MarkDown</a> et stockés dans un repository Git sur <a href="http://github.com/pullrequest/pullrequest.github.com">Github</a>.
            N'hésitez pas à <strong>forker</strong> puis à faire une <strong><a href="https://github.com/pullrequest/pullrequest.github.com/pull/new/master">Pull Request</a></strong> ;)
          </p>
        </section>
        <section id="licensing">
          <h1>Licence</h1>
          <p>
            Les articles sont mis à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by/2.0/fr/">Licence Creative Commons Paternité 2.0 France</a>.
            <a rel="license" href="http://creativecommons.org/licenses/by/2.0/fr/">
              <br><img alt="Contrat Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by/2.0/fr/88x31.png" />
            </a>
          </p>
        </section>
        <section id="opensource">
          <h1>OpenSource</h1>
          <p>Les auteurs de PullRequest sont à l'origine, ou contributeurs, entre autres, de ces projets:</p>
          <ul>
            <li><a href="http://openscales.org">OpenScales</a></li>
            <li><a href="http://resthub.org">RestHub</a></li>
            <li><a href="https://github.com/loicfrering/LosoBundle">LosoBundle</a></li>
            <li><a href="https://github.com/loicfrering/losolib">LoSoLib</a></li>
            <li><a href="https://bitbucket.org/feugy/myth">Myth</a></li>
          </ul>
        </section>
      </aside>

    </div>

    <footer>
      <small id="legal">© 2011 pullrequest.org</small>
      <small id="poweredby">Propulsé par <a href="http://jekyllrb.com">Jekyll</a></small>
    </footer>
  </div>

  <script defer src="/public/js/tags.js"></script>
  <script defer src="/public/js/authors.js"></script>

  <script>
    var _gaq=[["_setAccount","UA-22833612-1"],["_trackPageview"]];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
    g.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js";
    s.parentNode.insertBefore(g,s)}(document,"script"));
  </script>

  <!--[if lt IE 7 ]>
  <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
  <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

</body>
</html>
